/*
Gl«Ωmscribe (also written Glaemscribe) is a software dedicated to
the transcription of texts between writing systems, and more 
specifically dedicated to the transcription of J.R.R. Tolkien's 
invented languages to some of his devised writing systems.

Copyright (C) 2015 Benjamin Babut (Talagan).

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/
function stringListToCleanArray(e,r){return e.split(r).map(function(e){return e.trim()}).filter(function(e){return""!=e})}/*! http://mths.be/fromcodepoint v0.1.0 by @mathias */
String.fromCodePoint||!function(){var e=function(){try{var e={},r=Object.defineProperty,s=r(e,e,e)&&r}catch(t){}return s}(),r=String.fromCharCode,s=Math.floor,t=function(){var e,t,o=16384,a=[],n=-1,i=arguments.length;if(!i)return"";for(var l="";++n<i;){var c=Number(arguments[n]);if(!isFinite(c)||0>c||c>1114111||s(c)!=c)throw RangeError("Invalid code point: "+c);65535>=c?a.push(c):(c-=65536,e=(c>>10)+55296,t=c%1024+56320,a.push(e,t)),(n+1==i||a.length>o)&&(l+=r.apply(null,a),a.length=0)}return l};e?e(String,"fromCodePoint",{value:t,configurable:!0,writable:!0}):String.fromCodePoint=t}(),Function.prototype.inheritsFrom=function(e){return e.constructor==Function?(this.prototype=new e,this.prototype.constructor=this,this.prototype.parent=e.prototype):(this.prototype=e,this.prototype.constructor=this,this.prototype.parent=e),this},Object.defineProperty(Array.prototype,"productize",{enumerable:!1,value:function(e){for(var r=this,s=new Array(r.length*e.length),t=0;t<r.length;t++)for(var o=0;o<e.length;o++)s[t*e.length+o]=[r[t],e[o]];return s}}),Object.defineProperty(Array.prototype,"equals",{enumerable:!1,value:function(e){if(!e)return!1;if(this.length!=e.length)return!1;for(var r=0,s=this.length;s>r;r++)if(this[r]instanceof Array&&e[r]instanceof Array){if(!this[r].equals(e[r]))return!1}else if(this[r]!=e[r])return!1;return!0}}),Object.defineProperty(Array.prototype,"unique",{enumerable:!1,value:function(){var e=function(e,r,s){return s.indexOf(e)===r};return this.filter(e)}}),Object.defineProperty(Object.prototype,"glaem_each",{enumerable:!1,value:function(e){for(var r in this)this.hasOwnProperty(r)&&e(r,this[r])}}),Object.defineProperty(Object.prototype,"glaem_merge",{enumerable:!1,value:function(e){var r={};for(var s in this)this.hasOwnProperty(s)&&(r[s]=this[s]);for(var s in e)e.hasOwnProperty(s)&&(r[s]=e[s]);return r}});var Glaemscribe={};Glaemscribe.WORD_BREAKER="|",Glaemscribe.WORD_BOUNDARY="_",Glaemscribe.UNKNOWN_CHAR_OUTPUT="\u2620",Glaemscribe.ResourceManager=function(){return this.raw_modes={},this.raw_charsets={},this.loaded_modes={},this.loaded_charsets={},this.pre_processor_operator_classes={},this.post_processor_operator_classes={},this},Glaemscribe.ResourceManager.prototype.load_charsets=function(e){null==e&&(e=Object.keys(this.raw_charsets)),("string"==typeof e||e instanceof String)&&(e=[e]);for(var r=0;r<e.length;r++){var s=e[r];if(!this.loaded_charsets[s]&&this.raw_charsets[s]){var t=new Glaemscribe.CharsetParser,o=t.parse(s);o&&(this.loaded_charsets[s]=o)}}},Glaemscribe.ResourceManager.prototype.load_modes=function(e){null==e&&(e=Object.keys(this.raw_modes)),("string"==typeof e||e instanceof String)&&(e=[e]);for(var r=0;r<e.length;r++){var s=e[r];if(!this.loaded_modes[s]&&this.raw_modes[s]){var t=new Glaemscribe.ModeParser,o=t.parse(s);o&&(this.loaded_modes[s]=o)}}},Glaemscribe.ResourceManager.prototype.register_pre_processor_class=function(e,r){this.pre_processor_operator_classes[e]=r},Glaemscribe.ResourceManager.prototype.register_post_processor_class=function(e,r){this.post_processor_operator_classes[e]=r},Glaemscribe.ResourceManager.prototype.class_for_pre_processor_operator_name=function(e){return this.pre_processor_operator_classes[e]},Glaemscribe.ResourceManager.prototype.class_for_post_processor_operator_name=function(e){return this.post_processor_operator_classes[e]},Glaemscribe.resource_manager=new Glaemscribe.ResourceManager,Glaemscribe.Char=function(){return this},Glaemscribe.Charset=function(e){return this.name=e,this.chars=[],this.errors=[],this},Glaemscribe.Charset.prototype.add_char=function(e,r,s){if(void 0!=s&&0!=s.length&&-1==s.indexOf("?")){var t=new Glaemscribe.Char;t.line=e,t.code=r,t.names=s,t.str=String.fromCodePoint(r),this.chars.push(t)}},Glaemscribe.Charset.prototype.finalize=function(){this.errors=[],this.lookup_table={},this.chars=this.chars.sort(function(e,r){return e.code-r.code});for(var e=0;e<this.chars.length;e++)for(var r=this.chars[e],s=0;s<r.names.length;s++){var t=r.names[s],o=this.lookup_table[t];null!=o?this.errors.push(new Glaemscribe.Glaeml.Error(r.line,"Character "+t+" found twice.")):this.lookup_table[t]=r}},Glaemscribe.Charset.prototype.n2c=function(e){return this.lookup_table[e]},Glaemscribe.CharsetParser=function(){return this},Glaemscribe.CharsetParser.prototype.parse_raw=function(e,r){var s=new Glaemscribe.Charset(e),t=(new Glaemscribe.Glaeml.Parser).parse(r);if(t.errors.length>0)return s.errors=t.errors,s;for(var o=t.root_node.gpath("char"),a=0;a<o.length;a++){var n=o[a];code=parseInt(n.args[0],16),names=n.args.slice(1),s.add_char(n.line,code,names)}return s.finalize(),s},Glaemscribe.CharsetParser.prototype.parse=function(e){var r=Glaemscribe.resource_manager.raw_charsets[e];return this.parse_raw(e,r)},Glaemscribe.Glaeml={},Glaemscribe.Glaeml.Document=function(){return this.errors=[],this.root_node=null,this},Glaemscribe.Glaeml.NodeType={},Glaemscribe.Glaeml.NodeType.Text=0,Glaemscribe.Glaeml.NodeType.ElementInline=1,Glaemscribe.Glaeml.NodeType.ElementBlock=2,Glaemscribe.Glaeml.Node=function(e,r,s){return this.type=r,this.name=s,this.line=e,this.args=[],this.children=[],this},Glaemscribe.Glaeml.Node.prototype.is_text=function(){return this.type==Glaemscribe.Glaeml.NodeType.Text},Glaemscribe.Glaeml.Node.prototype.is_element=function(){return this.type==Glaemscribe.Glaeml.NodeType.ElementInline||this.Type==Glaemscribe.Glaeml.NodeType.ElementBlock},Glaemscribe.Glaeml.Node.prototype.pathfind_crawl=function(e,r){for(var s=this,t=0;t<s.children.length;t++){var o=s.children[t];if(o.name==e[0])if(1==e.length)r.push(o);else{var a=e.slice(0);a.shift(),o.pathfind_crawl(a,r)}}},Glaemscribe.Glaeml.Node.prototype.gpath=function(e){var r=e.split("."),s=[];return this.pathfind_crawl(r,s),s},Glaemscribe.Glaeml.Error=function(e,r){return this.line=e,this.text=r,this},Glaemscribe.Glaeml.Parser=function(){},Glaemscribe.Glaeml.Parser.prototype.add_text_node=function(e,r){var s=new Glaemscribe.Glaeml.Node(e,Glaemscribe.Glaeml.NodeType.Text,null);s.args.push(r),s.parent_node=this.current_parent_node,this.current_parent_node.children.push(s)},Glaemscribe.Glaeml.Parser.prototype.parse=function(e){e=e.replace(/\r/g,""),e=e.replace(/\\\*\*([\s\S]*?)\*\*\\/gm,function(e){return new Array((e.match(/\n/g)||[]).length+1).join("\n")});var r=0,s=this,t=new Glaemscribe.Glaeml.Document;t.root_node=new Glaemscribe.Glaeml.Node(r,Glaemscribe.Glaeml.NodeType.ElementBlock,"root"),s.current_parent_node=t.root_node;for(var o=e.split("\n"),a=0;a<o.length;a++){r+=1;var n=o[a];if(n=n.trim(),""!=n)if("\\"==n[0])if(1==n.length)t.errors.push(new Glaemscribe.Glaeml.Error(r,"Incomplete Node"));else{var i=null;if("\\"==n[1])s.add_text_node(r,n.substring(1));else if(i=n.match(/^(\\beg\s+)/)){var l=i[0],c=n.substring(l.length),p=[],u="???";if(i=c.match(/^([a-z_]+)/)){u=i[0];try{p=shellwords.split(c.substring(u.length))}catch(h){t.errors.push(new Glaemscribe.Glaeml.Error(r,"Error parsing args ("+h+")."))}}else t.errors.push(new Glaemscribe.Glaeml.Error(r,"Bad element name."));var m=new Glaemscribe.Glaeml.Node(r,Glaemscribe.Glaeml.NodeType.ElementBlock,u);m.args=m.args.concat(p),m.parent_node=s.current_parent_node,s.current_parent_node.children.push(m),s.current_parent_node=m}else if(i=n.match(/^(\\end(\s|$))/))s.current_parent_node.parent_node?""!=n.substring(i[0].length).trim()?t.errors.push(new Glaemscribe.Glaeml.Error(r,"Element 'end' should not have any argument.")):s.current_parent_node=s.current_parent_node.parent_node:t.errors.push(new Glaemscribe.Glaeml.Error(r,"Element 'end' unexpected."));else if(n=n.substring(1),i=n.match(/^([a-z_]+)/)){var u=i[0],p=[];try{p=shellwords.split(n.substring(u.length))}catch(h){t.errors.push(new Glaemscribe.Glaeml.Error(r,"Error parsing args ("+h+")."))}m=new Glaemscribe.Glaeml.Node(r,Glaemscribe.Glaeml.NodeType.ElementInline,u),m.args=m.args.concat(p),m.parent_node=s.current_parent_node,s.current_parent_node.children.push(m)}else t.errors.push(new Glaemscribe.Glaeml.Error(r,"Cannot understand element name."))}else s.add_text_node(r,n);else s.add_text_node(r,n)}return s.current_parent_node!=t.root_node&&t.errors.push(new Glaemscribe.Glaeml.Error(r,"Missing 'end' element.")),t},Glaemscribe.Fragment=function(e,r){var s=this;if(s.sheaf=e,s.mode=e.mode,s.rule=e.rule,s.expression=r,s.equivalences=stringListToCleanArray(s.expression,Glaemscribe.Fragment.EQUIVALENCE_RX_OUT),s.equivalences=s.equivalences.map(function(e){var r=e,t=Glaemscribe.Fragment.EQUIVALENCE_RX_IN.exec(e);return t?(r=t[1],r=r.split(Glaemscribe.Fragment.EQUIVALENCE_SEPARATOR).map(function(e){return e=e.trim(),""==e?void s.rule.errors.push("Null members are not allowed in equivalences!"):e.split(/\s/)})):r=[e.split(/\s/)],r}),0==s.equivalences.length&&(s.equivalences=[[[""]]]),s.is_dst())for(var t=s.sheaf.mode,o=0;o<s.equivalences.length;o++)for(var a=s.equivalences[o],n=0;n<a.length;n++)for(var i=a[n],l=0;l<i.length;l++){var c=i[l];if(""!=c)for(var p in t.supported_charsets){var u=t.supported_charsets[p],h=u.n2c(c);if(null==h)return void s.rule.errors.push("Symbol '"+c+"' not found in charset '"+u.name+"'!")}}for(var m=s.equivalences[0],o=0;o<s.equivalences.length-1;o++){var _=m.productize(s.equivalences[o+1]);m=_.map(function(e){var r=e[0],s=e[1];return r.concat(s)})}s.combinations=m},Glaemscribe.Fragment.EQUIVALENCE_SEPARATOR=",",Glaemscribe.Fragment.EQUIVALENCE_RX_OUT=/(\(.*?\))/,Glaemscribe.Fragment.EQUIVALENCE_RX_IN=/\((.*?)\)/,Glaemscribe.Fragment.prototype.is_src=function(){return this.sheaf.is_src()},Glaemscribe.Fragment.prototype.is_dst=function(){return this.sheaf.is_dst()},Glaemscribe.ModeDebugContext=function(){return this.preprocessor_output="",this.processor_pathes=[],this.processor_output="",this.postprocessor_output="",this},Glaemscribe.Mode=function(e){return this.name=e,this.supported_charsets={},this.options={},this.errors=[],this.warnings=[],this.pre_processor=new Glaemscribe.TranscriptionPreProcessor(this),this.processor=new Glaemscribe.TranscriptionProcessor(this),this.post_processor=new Glaemscribe.TranscriptionPostProcessor(this),this},Glaemscribe.Mode.prototype.finalize=function(e){var r=this;null==e&&(e={});var s={};r.options.glaem_each(function(e,r){s[e]=r.default_value_name}),e.glaem_each(function(e,t){var o=r.options[e];if(!o)return!0;var a=o.value_for_value_name(t);return null==a?!0:void(s[e]=t)});var t={};s.glaem_each(function(e,s){t[e]=r.options[e].value_for_value_name(s)}),r.options.glaem_each(function(e,r){r.type==Glaemscribe.Option.Type.ENUM&&r.values.glaem_each(function(e,r){t[e]=r})}),this.pre_processor.finalize(t),this.post_processor.finalize(t),this.processor.finalize(t)},Glaemscribe.Mode.prototype.transcribe=function(e,r){var s=new Glaemscribe.ModeDebugContext;if(null==r&&(r=this.default_charset),null==r)return[!1,"*** No charset usable for transcription. Failed!"];for(var t="",o=e.split("\n"),a=0;a<o.length;a++){var n=o[a].trim();n=this.pre_processor.apply(n),s.preprocessor_output+=n+"\n",n=this.processor.apply(n,r,s),s.processor_output+=n+"\n",n=this.post_processor.apply(n),s.postprocessor_output+=n+"\n",t+=n+"\n"}return[!0,t,s]},Glaemscribe.Option=function(e,r,s){return this.name=e,this.default_value_name=r,this.type=0==Object.keys(s).length?Glaemscribe.Option.Type.BOOL:Glaemscribe.Option.Type.ENUM,this.values=s,this},Glaemscribe.Option.Type={},Glaemscribe.Option.Type.BOOL="BOOL",Glaemscribe.Option.Type.ENUM="ENUM",Glaemscribe.Option.prototype.default_value=function(){return this.type==Glaemscribe.Option.Type.BOOL?"true"==this.default_value_name:this.values[this.default_value_name]},Glaemscribe.Option.prototype.value_for_value_name=function(e){return this.type==Glaemscribe.Option.Type.BOOL?"true"==e||1==e?!0:"false"==e||0==e?!1:null:this.values[e]},Glaemscribe.ModeParser=function(){return this},Glaemscribe.ModeParser.prototype.validate_presence_of_args=function(e,r){var s=this;null!=r&&e.args.length!=r&&s.mode.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Element '"+e.name+"' should have "+r+" arguments."))},Glaemscribe.ModeParser.prototype.validate_presence_of_children=function(e,r,s,t){var o=this,a=e.gpath(r);s&&a.length!=s&&o.mode.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Element '"+e.name+"' should have exactly "+s+" children of type '"+r+"'.")),t&&a.glaem_each(function(e,r){o.validate_presence_of_args(r,t)})},Glaemscribe.ModeParser.prototype.verify_mode_glaeml=function(r){var s=this;s.validate_presence_of_children(r.root_node,"language",1,1),s.validate_presence_of_children(r.root_node,"writing",1,1),s.validate_presence_of_children(r.root_node,"mode",1,1),s.validate_presence_of_children(r.root_node,"authors",1,1),s.validate_presence_of_children(r.root_node,"version",1,1),r.root_node.gpath("charset").glaem_each(function(e,r){s.validate_presence_of_args(r,2)}),r.root_node.gpath("options.option").glaem_each(function(e,r){s.validate_presence_of_args(r,2),r.gpath("value").glaem_each(function(e,r){s.validate_presence_of_args(r,2)})}),r.root_node.gpath("processor.outspace").glaem_each(function(e,r){s.validate_presence_of_args(r,1)}),r.root_node.gpath("processor.rules").glaem_each(function(e,r){s.validate_presence_of_args(r,1),s.validate_presence_of_children(r,"if",null,1),s.validate_presence_of_children(r,"elsif",null,1)}),r.root_node.gpath("preprocessor.if").glaem_each(function(r,s){validate_presence_of_args(e,1)}),r.root_node.gpath("preprocessor.elsif").glaem_each(function(r,s){validate_presence_of_args(e,1)}),r.root_node.gpath("postprocessor.if").glaem_each(function(r,s){validate_presence_of_args(e,1)}),r.root_node.gpath("postprocessor.elsif").glaem_each(function(r,s){validate_presence_of_args(e,1)})},Glaemscribe.ModeParser.prototype.create_if_cond_for_if_term=function(e,r,s){var t=new Glaemscribe.IfTree.IfCond(e,r,s),o=new Glaemscribe.IfTree.CodeBlock(t);return t.child_code_block=o,r.if_conds.push(t),t},Glaemscribe.ModeParser.prototype.traverse_if_tree=function(e,r,s,t){for(var o=this.mode,a=e,n=0;n<r.children.length;n++){var i=r.children[n];if(i.is_text())null!=s&&s(a,i);else if(i.is_element())switch(i.name){case"if":var l=i.args[0],c=new Glaemscribe.IfTree.IfTerm(a);a.terms.push(c);var p=this.create_if_cond_for_if_term(i.line,c,l);a=p.child_code_block;break;case"elsif":var l=i.args[0],c=a.parent_if_cond.parent_if_term;if(null==c)return void o.errors.push(new Glaemscribe.Glaeml.Error(i.line,"'elsif' without a 'if'."));var p=this.create_if_cond_for_if_term(i.line,c,l);a=p.child_code_block;break;case"else":var c=a.parent_if_cond.parent_if_term;if(null==c)return void o.errors.push(new Glaemscribe.Glaeml.Error(i.line,"'else' without a 'if'."));var p=this.create_if_cond_for_if_term(i.line,c,"true");a=p.child_code_block;break;case"endif":var c=a.parent_if_cond.parent_if_term;if(null==c)return void o.errors.push(new Glaemscribe.Glaeml.Error(i.line,"'endif' without a 'if'."));a=c.parent_code_block;break;default:null!=t&&t(a,i)}}a.parent_if_cond&&o.errors.push(new Glaemscribe.Glaeml.Error(i.line,"Unended 'if' at the end of this '"+r.name+"' element."))},Glaemscribe.ModeParser.prototype.parse_pre_post_processor=function(e,r){var s=this.mode,t=function(e,r){},o=function(e,t){var o=e.terms[e.terms.length-1];null!=o&&o.is_pre_post_processor_operators()||(o=new Glaemscribe.IfTree.PrePostProcessorOperatorsTerm(e),e.terms.push(o));var a=t.name,n=null;if(n=r?Glaemscribe.resource_manager.class_for_pre_processor_operator_name(a):Glaemscribe.resource_manager.class_for_post_processor_operator_name(a)){var i=t.args[0],l=t.args[1],c=t.args[2],p=t.args[3];o.operators.push(new n([i,l,c,p]))}else s.errors.push(new Glaemscribe.Glaeml.Error(t.line,"Operator '"+a+"' is unknown."))},a=r?s.pre_processor.root_code_block:s.post_processor.root_code_block;this.traverse_if_tree(a,e,t,o)},Glaemscribe.ModeParser.prototype.parse_raw=function(e,r,s){var t=new Glaemscribe.Mode(e);if(this.mode=t,t.raw=r,null==r)return t.errors.push(new Glaemscribe.Glaeml.Error(0,"No sourcecode. Forgot to load it?")),t;null==s&&(s={});var o=(new Glaemscribe.Glaeml.Parser).parse(r);if(o.errors.length>0)return t.errors=o.errors,t;if(this.verify_mode_glaeml(o),t.errors.length>0)return t;t.language=o.root_node.gpath("language")[0].args[0],t.writing=o.root_node.gpath("writing")[0].args[0],t.human_name=o.root_node.gpath("mode")[0].args[0],t.authors=o.root_node.gpath("authors")[0].args[0],t.version=o.root_node.gpath("version")[0].args[0];for(var a=o.root_node.gpath("options.option"),n=0;n<a.length;n++){for(var i=a[n],l={},c=i.gpath("value"),p=0;p<c.length;p++){var u=c[p],h=u.args[0];l[h]=parseInt(u.args[1])}var m=i.args[0],_=i.args[1];null==_&&t.errors.push(new Glaemscribe.Glaeml.Error(i.line,"Missing option 'default' value.")),option=new Glaemscribe.Option(m,_,l),t.options[option.name]=option}for(var f=o.root_node.gpath("charset"),b=0;b<f.length;b++){var d=f[b],G=d.args[0],v=Glaemscribe.resource_manager.loaded_charsets[G];if(v||(Glaemscribe.resource_manager.load_charsets([G]),v=Glaemscribe.resource_manager.loaded_charsets[G]),v){if(v.errors.length>0){for(var g=0;g<v.errors.length;g++){var P=v.errors[g];t.errors.push(new Glaemscribe.Glaeml.Error(d.line,G+":"+P.line+":"+P.text))}return t}t.supported_charsets[G]=v;var y=d.args[1];y&&"true"==y&&(t.default_charset=v)}else t.warnings.push(new Glaemscribe.Glaeml.Error(d.line,"Failed to load charset '"+G+"'."))}t.default_charset||t.warnings.push(new Glaemscribe.Glaeml.Error(0,"No default charset defined!!"));var w=o.root_node.gpath("preprocessor")[0];w&&this.parse_pre_post_processor(w,!0);var E=o.root_node.gpath("postprocessor")[0];E&&this.parse_pre_post_processor(E,!1);var T=o.root_node.gpath("processor.outspace")[0];if(T){var x=T.args[0];t.processor.out_space=stringListToCleanArray(x,/\s/)}for(var O=o.root_node.gpath("processor.rules"),R=0;R<O.length;R++){var k=O[R],N=k.args[0],C=new Glaemscribe.RuleGroup(t,N);t.processor.rule_groups[N]=C;var I=function(e,r){var s=e.terms[e.terms.length-1];null!=s&&s.is_code_lines()||(s=new Glaemscribe.IfTree.CodeLinesTerm(e),e.terms.push(s));for(var t=r.line,o=r.args[0].split("\n"),a=0;a<o.length;a++){var n=o[a].trim(),i=new Glaemscribe.IfTree.CodeLine(n,t);s.code_lines.push(i),t+=1}},S=function(e,r){t.errors.push(new Glaemscribe.Glaeml.Error(r.line,"Unknown directive "+r.name+"."))};this.traverse_if_tree(C.root_code_block,k,I,S)}return 0==t.errors.length&&t.finalize(s),t},Glaemscribe.ModeParser.prototype.parse=function(e){var r=this,s=Glaemscribe.resource_manager.raw_modes[e];return r.parse_raw(e,s)},Glaemscribe.Rule=function(e,r){this.line=e,this.rule_group=r,this.mode=r.mode,this.sub_rules=[],this.errors=[]},Glaemscribe.Rule.prototype.finalize=function(e){if(this.errors.length>0)for(var r=0;r<this.errors.length;r++){var s=this.errors[r];this.mode.errors.push(new Glaemscribe.Glaeml.Error(this.line,s))}else{var t=new Glaemscribe.SheafChainIterator(this.src_sheaf_chain),o=new Glaemscribe.SheafChainIterator(this.dst_sheaf_chain,e);if(t.errors.length>0)for(var r=0;r<t.errors.length;r++){var s=t.errors[r];this.mode.errors.push(new Glaemscribe.Glaeml.Error(this.line,s))}else if(o.errors.length>0)for(var r=0;r<o.errors.length;r++){var s=o.errors[r];this.mode.errors.push(new Glaemscribe.Glaeml.Error(this.line,s))}else{var a=t.proto(),n=o.proto();if(a!=n)return void this.mode.errors.push(new Glaemscribe.Glaeml.Error(this.line,"Source and destination are not compatible ("+a+" vs "+n+")"));do{for(var i=t.combinations(),l=o.combinations()[0],c=0;c<i.length;c++){var p=i[c];this.sub_rules.push(new Glaemscribe.SubRule(this,p,l))}o.iterate()}while(t.iterate())}}},Glaemscribe.RuleGroup=function(e,r){return this.name=r,this.mode=e,this.root_code_block=new Glaemscribe.IfTree.CodeBlock,this},Glaemscribe.RuleGroup.VAR_NAME_REGEXP=/{([0-9A-Z_]+)}/g,Glaemscribe.RuleGroup.prototype.add_var=function(e,r){this.vars[e]=r},Glaemscribe.RuleGroup.prototype.apply_vars=function(e,r){var s=this,t=this.mode,o=!1,a=r.replace(Glaemscribe.RuleGroup.VAR_NAME_REGEXP,function(a,n,i,l){var c=s.vars[n];return null==c?(t.errors.push(new Glaemscribe.Glaeml.Error(e,"In expression: "+r+": failed to evaluate variable: "+n+".")),o=!0,""):c});return o?null:a},Glaemscribe.RuleGroup.prototype.descend_if_tree=function(e,r){for(var s=this.mode,t=0;t<e.terms.length;t++){var o=e.terms[t];if(o.is_code_lines())for(var a=0;a<o.code_lines.length;a++){var n=o.code_lines[a];this.finalize_code_line(n)}else for(var i=0;i<o.if_conds.length;i++){var l=o.if_conds[i],c=new Glaemscribe.Eval.Parser,p=!1;try{p=c.parse(l.expression,r)}catch(u){s.errors.push(new Glaemscribe.Glaeml.Error(l.line,"Failed to evaluate condition '"+l.expression+"'."))}if(1==p){this.descend_if_tree(l.child_code_block,r);break}}}},Glaemscribe.RuleGroup.VAR_DECL_REGEXP=/^\s*{([0-9A-Z_]+)}\s+===\s+(.+?)\s*$/,Glaemscribe.RuleGroup.RULE_REGEXP=/^\s*(.*?)\s+-->\s+(.+?)\s*$/,Glaemscribe.RuleGroup.CROSS_RULE_REGEXP=/^\s*(.*?)\s+-->\s+([\s0-9,]+)\s+-->\s+(.+?)\s*$/,Glaemscribe.RuleGroup.prototype.finalize_rule=function(e,r,s,t){var o=this.apply_vars(e,r),a=this.apply_vars(e,s);if(null!=o&&null!=a){var n=new Glaemscribe.Rule(e,this);n.src_sheaf_chain=new Glaemscribe.SheafChain(n,o,!0),n.dst_sheaf_chain=new Glaemscribe.SheafChain(n,a,!1),n.finalize(t),this.rules.push(n)}},Glaemscribe.RuleGroup.prototype.finalize_code_line=function(e){var r=this.mode;if(exp=Glaemscribe.RuleGroup.VAR_DECL_REGEXP.exec(e.expression)){var s=exp[1],t=exp[2],o=this.apply_vars(e.line,t);if(null==o)return void r.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Thus, variable {"+s+"} could not be declared."));this.add_var(s,o)}else if(exp=Glaemscribe.RuleGroup.CROSS_RULE_REGEXP.exec(e.expression)){var a=exp[1],n=exp[2],i=exp[3];this.finalize_rule(e.line,a,i,n)}else if(exp=Glaemscribe.RuleGroup.RULE_REGEXP.exec(e.expression)){var a=exp[1],i=exp[2];this.finalize_rule(e.line,a,i)}else""==e.expression||r.errors.push(new Glaemscribe.Glaeml.Error(e.line,": Cannot understand '"+e.expression+"'."))},Glaemscribe.RuleGroup.prototype.finalize=function(e){var r=this;this.vars={},this.in_charset={},this.rules=[],this.add_var("NULL",""),this.descend_if_tree(this.root_code_block,e),r.in_charset={};for(var s=0;s<r.rules.length;s++)for(var t=r.rules[s],o=0;o<t.sub_rules.length;o++)for(var a=t.sub_rules[o],n=a.src_combination.join("").split(""),i=0;i<n.length;i++){var l=n[i];l!=Glaemscribe.WORD_BREAKER&&l!=Glaemscribe.WORD_BOUNDARY&&(r.in_charset[l]=r)}},Glaemscribe.SubRule=function(e,r,s){this.src_combination=r,this.dst_combination=s},Glaemscribe.Sheaf=function(e,r){var s=this;s.sheaf_chain=e,s.mode=e.mode,s.rule=e.rule,s.expression=r,s.fragment_exps=r.split(Glaemscribe.Sheaf.SHEAF_SEPARATOR).map(function(e){return e.trim()}),0==s.fragment_exps.length&&(s.fragment_exps=[""]),s.fragments=s.fragment_exps.map(function(e){return new Glaemscribe.Fragment(s,e)})},Glaemscribe.Sheaf.SHEAF_SEPARATOR="*",Glaemscribe.Sheaf.prototype.is_src=function(){return this.sheaf_chain.is_src},Glaemscribe.Sheaf.prototype.is_dst=function(){return!this.sheaf_chain.is_src},Glaemscribe.Sheaf.prototype.mode=function(){return this.sheaf_chain.mode()},Glaemscribe.SheafChain=function(e,r,s){var t=this;return t.rule=e,t.mode=e.mode,t.is_src=s,t.expression=r,t.sheaf_exps=stringListToCleanArray(r,Glaemscribe.SheafChain.SHEAF_REGEXP_OUT),t.sheaf_exps=t.sheaf_exps.map(function(e){var r=Glaemscribe.SheafChain.SHEAF_REGEXP_IN.exec(e);return r&&(e=r[1]),e.trim()}),t.sheaves=t.sheaf_exps.map(function(e){return new Glaemscribe.Sheaf(t,e)}),0==t.sheaves.length&&(t.sheaves=[new Glaemscribe.Sheaf(t,"")]),t},Glaemscribe.SheafChain.SHEAF_REGEXP_IN=/\[(.*?)\]/,Glaemscribe.SheafChain.SHEAF_REGEXP_OUT=/(\[.*?\])/,Glaemscribe.SheafChain.prototype.mode=function(){return this.rule.mode()},Glaemscribe.SheafChainIterator=function(e,r){var s=this;s.sheaf_chain=e,s.sizes=e.sheaves.map(function(e){return e.fragments.length}),s.iterators=s.sizes.map(function(e){return 0}),s.errors=[];for(var t=[],o=e.sheaves.length,a=0;o>a;a++)t.push(a+1);var n=null;if(null!=r){n=r.split(",").map(function(e){return parseInt(e)});var i=n.length;i!=o&&s.errors.push(o+" sheaves found in right predicate, but "+i+" elements in cross rule.");var l=n.slice(0);t.equals(l.sort())||s.errors.push("Cross rule should contain each element of "+t+" once and only once.")}else n=t;this.cross_array=n},Glaemscribe.SheafChainIterator.prototype.proto=function(){for(var e=this,r=e.sizes.slice(0),s=e.sizes.slice(0),t=0;t<r.length;t++)s[t]=r[e.cross_array[t]-1];return r=s.filter(function(e){return 1!=e}),r=r.join("x"),""==r&&(r="1"),r},Glaemscribe.SheafChainIterator.prototype.combinations=function(){for(var e=this,r=[],s=0;s<e.iterators.length;s++){var t=e.iterators[s],o=e.sheaf_chain.sheaves[s],a=o.fragments[t];r.push(a.combinations)}for(var n=r[0],s=0;s<r.length-1;s++){var i=n.productize(r[s+1]);n=i.map(function(e){var r=e[0],s=e[1];return r.concat(s)})}return n},Glaemscribe.SheafChainIterator.prototype.iterate=function(){for(var e=this,r=0;r<e.sizes.length;){var s=e.cross_array[r]-1;if(e.iterators[s]+=1,!(e.iterators[s]>=e.sizes[s]))return!0;e.iterators[s]=0,r+=1}return!1},Glaemscribe.IfTree={},Glaemscribe.IfTree.IfCond=function(e,r,s){return this.line=e,this.parent_if_term=r,this.expression=s,this},Glaemscribe.IfTree.Term=function(e){return this.parent_code_block=e,this},Glaemscribe.IfTree.Term.prototype.is_code_lines=function(){return!1},Glaemscribe.IfTree.Term.prototype.is_pre_post_processor_operators=function(){return!1},Glaemscribe.IfTree.Term.prototype.name=function(){return"TERM"},Glaemscribe.IfTree.Term.prototype.dump=function(e){for(var r="",s=0;e>s;s++)r+=" ";r+="|-"+this.name(),console.log(r)},Glaemscribe.IfTree.IfTerm=function(e){return Glaemscribe.IfTree.Term.call(this,e),this.if_conds=[],this},Glaemscribe.IfTree.IfTerm.inheritsFrom(Glaemscribe.IfTree.Term),Glaemscribe.IfTree.IfTerm.prototype.name=function(){return"IF_TERM"},Glaemscribe.IfTree.IfTerm.prototype.dump=function(e){this.parent.dump.call(this,e)},Glaemscribe.IfTree.CodeLine=function(e,r){return this.expression=e,this.line=r,this},Glaemscribe.IfTree.PrePostProcessorOperatorsTerm=function(e){return Glaemscribe.IfTree.Term.call(this,e),this.operators=[],this},Glaemscribe.IfTree.PrePostProcessorOperatorsTerm.inheritsFrom(Glaemscribe.IfTree.Term),Glaemscribe.IfTree.PrePostProcessorOperatorsTerm.prototype.name=function(){return"OP_TERM"},Glaemscribe.IfTree.PrePostProcessorOperatorsTerm.prototype.is_pre_post_processor_operators=function(){return!0},Glaemscribe.IfTree.CodeLinesTerm=function(e){return Glaemscribe.IfTree.Term.call(this,e),this.code_lines=[],this},Glaemscribe.IfTree.CodeLinesTerm.inheritsFrom(Glaemscribe.IfTree.Term),Glaemscribe.IfTree.CodeLinesTerm.prototype.name=function(){return"CL_TERM"},Glaemscribe.IfTree.CodeLinesTerm.prototype.is_code_lines=function(){return!0},Glaemscribe.IfTree.CodeBlock=function(e){return this.parent_if_cond=e,this.terms=[],this},Glaemscribe.IfTree.CodeBlock.prototype.dump=function(e){for(var r="",s=0;e>s;s++)r+=" ";r+="|-BLOCK",console.log(r);for(var t=0;t<this.terms.length;t++)this.terms[t].dump(e+1)},Glaemscribe.Eval={},Glaemscribe.Eval.Token=function(e,r){this.name=e,this.expression=r},Glaemscribe.Eval.Token.prototype.is_regexp=function(){return this.expression instanceof RegExp},Glaemscribe.Eval.Token.prototype.clone=function(e){var r=new Glaemscribe.Eval.Token(this.name,this.expression);return r.value=e,r},Glaemscribe.Eval.Lexer=function(e){this.exp=e,this.token_chain=[],this.retain_last=!1},Glaemscribe.Eval.Lexer.prototype.uneat=function(){this.retain_last=!0},Glaemscribe.Eval.Lexer.prototype.EXP_TOKENS=[new Glaemscribe.Eval.Token("bool_or","||"),new Glaemscribe.Eval.Token("bool_and","&&"),new Glaemscribe.Eval.Token("cond_inf_eq","<="),new Glaemscribe.Eval.Token("cond_inf","<"),new Glaemscribe.Eval.Token("cond_sup_eq",">="),new Glaemscribe.Eval.Token("cond_sup",">"),new Glaemscribe.Eval.Token("cond_eq","=="),new Glaemscribe.Eval.Token("cond_not_eq","!="),new Glaemscribe.Eval.Token("add_plus","+"),new Glaemscribe.Eval.Token("add_minus","-"),new Glaemscribe.Eval.Token("mult_times","*"),new Glaemscribe.Eval.Token("mult_div","/"),new Glaemscribe.Eval.Token("mult_modulo","%"),new Glaemscribe.Eval.Token("prim_not","!"),new Glaemscribe.Eval.Token("prim_lparen","("),new Glaemscribe.Eval.Token("prim_rparen",")"),new Glaemscribe.Eval.Token("prim_string",/^'[^']*'/),new Glaemscribe.Eval.Token("prim_string",/^"[^"]*"/),new Glaemscribe.Eval.Token("prim_const",/^[a-zA-Z0-9_.]+/)],Glaemscribe.Eval.Lexer.prototype.TOKEN_END=new Glaemscribe.Eval.Token("prim_end",""),Glaemscribe.Eval.Lexer.prototype.advance=function(){if(this.exp=this.exp.trim(),1==this.retain_last)return this.retain_last=!1,this.token_chain[this.token_chain.length-1];if(this.exp==Glaemscribe.Eval.Lexer.prototype.TOKEN_END.expression){var e=Glaemscribe.Eval.Lexer.prototype.TOKEN_END.clone("");return this.token_chain.push(e),e}for(var e=0;e<Glaemscribe.Eval.Lexer.prototype.EXP_TOKENS.length;e++){var r=Glaemscribe.Eval.Lexer.prototype.EXP_TOKENS[e];if(r.is_regexp()){var s=this.exp.match(r.expression);if(s){var t=s[0];this.exp=this.exp.substring(t.length);var e=r.clone(t);return this.token_chain.push(e),e}}else if(0==this.exp.indexOf(r.expression)){this.exp=this.exp.substring(r.expression.length);var e=r.clone(r.expression);return this.token_chain.push(e),e}}throw"UnknownToken"},Glaemscribe.Eval.Parser=function(){},Glaemscribe.Eval.Parser.prototype.parse=function(e,r){return this.lexer=new Glaemscribe.Eval.Lexer(e),this.vars=r,this.parse_top_level()},Glaemscribe.Eval.Parser.prototype.parse_top_level=function(){return this.explore_bool()},Glaemscribe.Eval.Parser.prototype.explore_bool=function(){for(var e=this.explore_compare(),r=!1;!r;)switch(this.lexer.advance().name){case"bool_or":1==e?this.explore_bool():e=this.explore_compare();break;case"bool_and":1==!e?this.explore_bool():e=this.explore_compare();break;default:r=!0}return this.lexer.uneat(),e},Glaemscribe.Eval.Parser.prototype.explore_compare=function(){for(var e=this.explore_add(),r=!1;!r;)switch(this.lexer.advance().name){case"cond_inf_eq":e=e<=this.explore_add();break;case"cond_inf":e=e<this.explore_add();break;case"cond_sup_eq":e=e>=this.explore_add();break;case"cond_sup":e=e>this.explore_add();break;case"cond_eq":e=e==this.explore_add();break;case"cond_not_eq":e=e!=this.explore_add();break;default:r=!0}return this.lexer.uneat(),e},Glaemscribe.Eval.Parser.prototype.explore_add=function(){for(var e=this.explore_mult(),r=!1;!r;)switch(this.lexer.advance().name){case"add_plus":e+=this.explore_mult();break;case"add_minus":e-=this.explore_mult();break;default:r=!0}return this.lexer.uneat(),e},Glaemscribe.Eval.Parser.prototype.explore_mult=function(){for(var e=this.explore_primary(),r=!1;!r;)switch(this.lexer.advance().name){case"mult_times":e*=this.explore_primary();break;case"mult_div":e/=this.explore_primary();break;case"mult_modulo":e%=this.explore_primary();break;default:r=!0}return this.lexer.uneat(),e},Glaemscribe.Eval.Parser.prototype.explore_primary=function(){var e=this.lexer.advance(),r=null;switch(e.name){case"prim_const":r=this.cast_constant(e.value);break;case"add_minus":r=-this.explore_primary();break;case"prim_not":r=!this.explore_primary();break;case"prim_lparen":r=this.parse_top_level();var s=this.lexer.advance();if("prim_rparen"!=s.name)throw"Missing right parenthesis.";break;default:throw"Cannot understand: "+e.value+"."}return r},Glaemscribe.Eval.Parser.prototype.constant_is_float=function(e){return isNaN(e)?!1:Number(e)%1!==0},Glaemscribe.Eval.Parser.prototype.constant_is_int=function(e){return isNaN(e)?!1:Number(e)%1===0},Glaemscribe.Eval.Parser.prototype.constant_is_string=function(e){if(e.length<2)return!1;var r=e[0],s=e[e.length-1];return r==s&&("'"==s||'"'==s)},Glaemscribe.Eval.Parser.prototype.cast_constant=function(e){var r=null;if(this.constant_is_int(e))return parseInt(e);if(this.constant_is_float(e))return parseFloat(e);if(r=e.match(/^\'(.*)\'$/))return r[0];if(r=e.match(/^\"(.*)\"$/))return r[0];if("true"==e)return!0;if("false"==e)return!1;if("nil"==e)return null;if(null!=this.vars[e])return this.vars[e];throw"Cannot understand constant '"+e+"'."},Glaemscribe.TranscriptionTreeNode=function(e,r,s){var t=this;t.character=e,t.replacement=r,t.path=s,t.siblings={}},Glaemscribe.TranscriptionTreeNode.prototype.is_effective=function(){return null!=this.replacement},Glaemscribe.TranscriptionTreeNode.prototype.add_subpath=function(e,r,s){if(null!=e&&""!=e){var t=this,o=e[0],a=t.siblings[o],n=(s||"")+o;null==a&&(a=new Glaemscribe.TranscriptionTreeNode(o,null,n)),t.siblings[o]=a,1==e.length?a.replacement=r:a.add_subpath(e.substring(1),r,n)}},Glaemscribe.TranscriptionTreeNode.prototype.transcribe=function(e,r){if(null==r&&(r=[]),r.push(this),""!=e){var s=e[0],t=this.siblings[s];if(t)return t.transcribe(e.substring(1),r)}for(;r.length>1;){var o=r.pop();if(o.is_effective())return[o.replacement,r.length];
}return[[Glaemscribe.UNKNOWN_CHAR_OUTPUT],1]},Glaemscribe.PrePostProcessorOperator=function(e){return this.raw_args=e,this},Glaemscribe.PrePostProcessorOperator.prototype.apply=function(e){throw"Pure virtual method, should be overloaded."},Glaemscribe.PrePostProcessorOperator.prototype.eval_arg=function(e,r){if(null==e)return null;var s=null;return(s=e.match(/^\\eval\s/))?(to_eval=e.substring(s[0].length),(new Glaemscribe.Eval.Parser).parse(to_eval,r)):e},Glaemscribe.PrePostProcessorOperator.prototype.finalize=function(e){var r=this;r.args=[],r.raw_args.glaem_each(function(s,t){r.args.push(r.eval_arg(t,e))})},Glaemscribe.PreProcessorOperator=function(e){return Glaemscribe.PrePostProcessorOperator.call(this,e),this},Glaemscribe.PreProcessorOperator.inheritsFrom(Glaemscribe.PrePostProcessorOperator),Glaemscribe.PostProcessorOperator=function(e){return Glaemscribe.PrePostProcessorOperator.call(this,e),this},Glaemscribe.PostProcessorOperator.inheritsFrom(Glaemscribe.PrePostProcessorOperator),Glaemscribe.TranscriptionPrePostProcessor=function(e){return this.mode=e,this.root_code_block=new Glaemscribe.IfTree.CodeBlock,this},Glaemscribe.TranscriptionPrePostProcessor.prototype.apply=function(e){for(var r=e,s=0;s<this.operators.length;s++){var t=this.operators[s];r=t.apply(r)}return r},Glaemscribe.TranscriptionPrePostProcessor.prototype.finalize=function(e){this.operators=[],this.descend_if_tree(this.root_code_block,e),this.operators.glaem_each(function(r,s){s.finalize(e)})},Glaemscribe.TranscriptionPrePostProcessor.prototype.descend_if_tree=function(e,r){for(var s=0;s<e.terms.length;s++){var t=e.terms[s];if(t.is_pre_post_processor_operators())for(var o=0;o<t.operators.length;o++){var a=t.operators[o];this.operators.push(a)}else for(var n=0;n<t.if_conds.length;n++){var i=t.if_conds[n],l=new Glaemscribe.Eval.Parser;if(1==l.parse(i.expression,r)){this.descend_if_tree(i.child_code_block,r);break}}}},Glaemscribe.TranscriptionPreProcessor=function(e){return Glaemscribe.TranscriptionPrePostProcessor.call(this,e),this},Glaemscribe.TranscriptionPreProcessor.inheritsFrom(Glaemscribe.TranscriptionPrePostProcessor),Glaemscribe.TranscriptionPostProcessor=function(e){return Glaemscribe.TranscriptionPrePostProcessor.call(this,e),this},Glaemscribe.TranscriptionPostProcessor.inheritsFrom(Glaemscribe.TranscriptionPrePostProcessor),Glaemscribe.TranscriptionProcessor=function(e){return this.mode=e,this.rule_groups={},this},Glaemscribe.TranscriptionProcessor.prototype.finalize=function(e){var r=this,s=this.mode;r.transcription_tree=new Glaemscribe.TranscriptionTreeNode(null,null,""),r.transcription_tree.add_subpath(Glaemscribe.WORD_BOUNDARY,[""]),r.transcription_tree.add_subpath(Glaemscribe.WORD_BREAKER,[""]),this.rule_groups.glaem_each(function(r,s){s.finalize(e)}),r.in_charset={},this.rule_groups.glaem_each(function(e,t){t.in_charset.glaem_each(function(e,t){var o=r.in_charset[e];null!=o?s.errors.push(new Glaemscribe.Glaeml.Error(0,"Group "+rgname+" uses input character "+e+" which is also used by group "+o.name+". Input charsets should not intersect between groups.")):r.in_charset[e]=t})}),this.rule_groups.glaem_each(function(e,s){for(var t=0;t<s.rules.length;t++)for(var o=s.rules[t],a=0;a<o.sub_rules.length;a++){var n=o.sub_rules[a];r.add_subrule(n)}})},Glaemscribe.TranscriptionProcessor.prototype.add_subrule=function(e){var r=e.src_combination.join("");this.transcription_tree.add_subpath(r,e.dst_combination)},Glaemscribe.TranscriptionProcessor.prototype.apply=function(e,r,s){var t="",o=null,a="",n=" ";null!=this.out_space&&(n=this.out_space.map(function(e){return r.n2c(e).str}).join(""));for(var i=e.split(""),l=0;l<i.length;l++){var c=i[l];switch(c){case" ":case"	":t+=this.transcribe_word(a,r,s),t+=n,a="";break;case"\r":case"\n":t+=this.transcribe_word(a,r,s),t+=c,a="";break;default:var p=this.in_charset[c];p==o?a+=c:(t+=this.transcribe_word(a,r,s),o=p,a=c)}}return t+=this.transcribe_word(a,r,s)},Glaemscribe.TranscriptionProcessor.prototype.transcribe_token=function(e,r){var s="";switch(e){case"":break;case Glaemscribe.UNKNOWN_CHAR_OUTPUT:s+=Glaemscribe.UNKNOWN_CHAR_OUTPUT;break;default:s+=r.n2c(e).str}return s},Glaemscribe.TranscriptionProcessor.prototype.transcribe_token_list=function(e,r){for(var s=this,t="",o=0;o<e.length;o++){var a=e[o];t+=s.transcribe_token(a,r)}return t},Glaemscribe.TranscriptionProcessor.prototype.transcribe_word=function(e,r,s){for(var t=this,o="",e=Glaemscribe.WORD_BOUNDARY+e+Glaemscribe.WORD_BOUNDARY;0!=e.length;){var a=this.transcription_tree.transcribe(e),n=a[0],i=a[1],l=t.transcribe_token_list(n,r),c=e.substring(0,i);e=e.substring(i),o+=l,s.processor_pathes.push([c,n,l])}return o},Glaemscribe.DowncasePreProcessorOperator=function(e){return Glaemscribe.PreProcessorOperator.call(this,e),this},Glaemscribe.DowncasePreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.DowncasePreProcessorOperator.prototype.apply=function(e){return e.toLowerCase()},Glaemscribe.resource_manager.register_pre_processor_class("downcase",Glaemscribe.DowncasePreProcessorOperator),Glaemscribe.RxSubstitutePreProcessorOperator=function(e){return Glaemscribe.PreProcessorOperator.call(this,e),this.raw_args[1]=this.raw_args[1].replace(/(\\\d)/g,function(e){return"$"+e.replace("\\","")}),this},Glaemscribe.RxSubstitutePreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.RxSubstitutePreProcessorOperator.prototype.apply=function(e){var r=new RegExp(this.args[0],"g"),s=this.args[1];return e.replace(r,s)},Glaemscribe.resource_manager.register_pre_processor_class("rxsubstitute",Glaemscribe.RxSubstitutePreProcessorOperator),Glaemscribe.SubstitutePreProcessorOperator=function(e){return Glaemscribe.PreProcessorOperator.call(this,e),this},Glaemscribe.SubstitutePreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.SubstitutePreProcessorOperator.prototype.apply=function(e){var r=new RegExp(this.args[0],"g"),s=this.args[1];return e.replace(r,s)},Glaemscribe.resource_manager.register_pre_processor_class("substitute",Glaemscribe.SubstitutePreProcessorOperator),Glaemscribe.UpDownTehtaSplitPreProcessorOperator=function(e){Glaemscribe.PreProcessorOperator.call(this,e);var r=e[0],s=e[1];r=r.split(/,/).map(function(e){return e.trim()}),s=s.split(/,/).map(function(e){return e.trim()}),this.vowel_map={},this.consonant_map={},this.splitter_tree=new Glaemscribe.TranscriptionTreeNode(null,null,""),this.word_split_map={};for(var t=0;t<r.length;t++){var o=r[t];this.splitter_tree.add_subpath(o,o),this.vowel_map[o]=o}for(var a=0;a<s.length;a++){var n=s[a];this.splitter_tree.add_subpath(n,n),this.consonant_map[n]=n}for(var i=r.concat(s).join("").split("").sort().unique(),l=0;l<i.length;l++){var c=i[l];this.word_split_map[c]=c}return this},Glaemscribe.UpDownTehtaSplitPreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.UpDownTehtaSplitPreProcessorOperator.prototype.type_of_token=function(e){return null!=this.vowel_map[e]?"V":null!=this.consonant_map[e]?"C":"X"},Glaemscribe.UpDownTehtaSplitPreProcessorOperator.prototype.apply_to_word=function(e){var r=[];if(""==e.trim())r.push(e);else for(;0!=e.length;){var s=this.splitter_tree.transcribe(e),t=s[0],o=s[1];t instanceof Array&&t.equals([Glaemscribe.UNKNOWN_CHAR_OUTPUT])?r.push(e[0]):r.push(t),e=e.substring(o)}for(var a=[],n=0;n<r.length-2;){var i=r[n],l=r[n+1],c=r[n+2],p=this.type_of_token(i),u=this.type_of_token(l),h=this.type_of_token(c);"C"==p&&"V"==u&&"C"==h?(a.push(r[n]),a.push("@"),a.push(r[n+1]),n+=2):(a.push(r[n]),n+=1)}for(;n<r.length;)a.push(r[n]),n+=1;return a.join("")},Glaemscribe.UpDownTehtaSplitPreProcessorOperator.prototype.apply=function(e){for(var r="",s="",t=e.split(""),o=0;o<t.length;o++){var a=t[o];null!=this.word_split_map[a]?r+=a:(s+=this.apply_to_word(r),s+=a,r="")}return s+=this.apply_to_word(r)},Glaemscribe.resource_manager.register_pre_processor_class("up_down_tehta_split",Glaemscribe.UpDownTehtaSplitPreProcessorOperator),Glaemscribe.ElvishNumbersPreProcessorOperator=function(e){return Glaemscribe.PreProcessorOperator.call(this,e),this},Glaemscribe.ElvishNumbersPreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.ElvishNumbersPreProcessorOperator.prototype.apply=function(e){var r=this,s=r.args[0];s=null!=s?parseInt(s):12;var t=r.args[1];return t=null!=t?1==t||"true"==t:!0,e.replace(/\d+/g,function(e){var r=parseInt(e).toString(s);r=r.toUpperCase();var o="";if(t)for(var a=r.length-1;a>=0;a--)o+=r[a];else o=r;return o})},Glaemscribe.resource_manager.register_pre_processor_class("elvish_numbers",Glaemscribe.ElvishNumbersPreProcessorOperator),Glaemscribe.ReversePostProcessorOperator=function(e){return Glaemscribe.PostProcessorOperator.call(this,e),this},Glaemscribe.ReversePostProcessorOperator.inheritsFrom(Glaemscribe.PostProcessorOperator),Glaemscribe.ReversePostProcessorOperator.prototype.apply=function(e){for(var r="",s=e.length-1;s>=0;s--)r+=e[s];return r},Glaemscribe.resource_manager.register_post_processor_class("reverse",Glaemscribe.ReversePostProcessorOperator),/*

Copyright (C) 2011 by Jimmy Cuadra

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

*/
function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var r;r="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,r.shellwords=e()}}(function(){return function e(r,s,t){function o(n,i){if(!s[n]){if(!r[n]){var l="function"==typeof require&&require;if(!i&&l)return l(n,!0);if(a)return a(n,!0);var c=new Error("Cannot find module '"+n+"'");throw c.code="MODULE_NOT_FOUND",c}var p=s[n]={exports:{}};r[n][0].call(p.exports,function(e){var s=r[n][1][e];return o(s?s:e)},p,p.exports,e,r,s,t)}return s[n].exports}for(var a="function"==typeof require&&require,n=0;n<t.length;n++)o(t[n]);return o}({1:[function(e,r,s){(function(){var e;e=function(e,r,s){var t,o;for(o="";e.length>0;)t=e.match(r),t?(o+=e.slice(0,t.index),o+=s(t),e=e.slice(t.index+t[0].length)):(o+=e,e="");return o},s.split=function(r){var s,t;return null==r&&(r=""),t=[],s="",e(r,/\s*(?:([^\s\\\'\"]+)|'((?:[^\'\\]|\\.)*)'|"((?:[^\"\\]|\\.)*)"|(\\.?)|(\S))(\s|$)?/,function(e){var r,o,a,n,i,l,c;if(n=e[0],c=e[1],l=e[2],r=e[3],o=e[4],a=e[5],i=e[6],null!=a)throw new Error("Unmatched quote");return s+=c||(l||r||o).replace(/\\(?=.)/,""),null!=i?(t.push(s),s=""):void 0}),s&&t.push(s),t},s.escape=function(e){return null==e&&(e=""),null==e?"''":e.replace(/([^A-Za-z0-9_\-.,:\/@\n])/g,"\\$1").replace(/\n/g,"'\n'")}}).call(this)},{}]},{},[1])(1)});