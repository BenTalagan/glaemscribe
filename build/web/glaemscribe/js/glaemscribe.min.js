/*
Gl«Ωmscribe (also written Glaemscribe) is a software dedicated to
the transcription of texts between writing systems, and more 
specifically dedicated to the transcription of J.R.R. Tolkien's 
invented languages to some of his devised writing systems.

Copyright (C) 2015 Benjamin Babut (Talagan).

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as published by
the Free Software Foundation, either version 3 of the License, or
any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

Version : 1.0.20
*/

function stringListToCleanArray(e,r){return e.split(r).map(function(e){return e.trim()}).filter(function(e){return""!=e})}String.fromCodePoint||!function(){var e=function(){try{var e={},r=Object.defineProperty,t=r(e,e,e)&&r}catch(s){}return t}(),r=String.fromCharCode,t=Math.floor,s=function(){var e,s,a=16384,o=[],i=-1,n=arguments.length;if(!n)return"";for(var l="";++i<n;){var c=Number(arguments[i]);if(!isFinite(c)||0>c||c>1114111||t(c)!=c)throw RangeError("Invalid code point: "+c);65535>=c?o.push(c):(c-=65536,e=(c>>10)+55296,s=c%1024+56320,o.push(e,s)),(i+1==n||o.length>a)&&(l+=r.apply(null,o),o.length=0)}return l};e?e(String,"fromCodePoint",{value:s,configurable:!0,writable:!0}):String.fromCodePoint=s}(),Function.prototype.inheritsFrom=function(e){return e.constructor==Function?(this.prototype=new e,this.prototype.constructor=this,this.prototype.parent=e.prototype):(this.prototype=e,this.prototype.constructor=this,this.prototype.parent=e),this},Object.defineProperty(Array.prototype,"productize",{enumerable:!1,value:function(e){for(var r=this,t=new Array(r.length*e.length),s=0;s<r.length;s++)for(var a=0;a<e.length;a++)t[s*e.length+a]=[r[s],e[a]];return t}}),Object.defineProperty(Array.prototype,"equals",{enumerable:!1,value:function(e){if(!e)return!1;if(this.length!=e.length)return!1;for(var r=0,t=this.length;t>r;r++)if(this[r]instanceof Array&&e[r]instanceof Array){if(!this[r].equals(e[r]))return!1}else if(this[r]!=e[r])return!1;return!0}}),Object.defineProperty(Array.prototype,"unique",{enumerable:!1,value:function(){var e=function(e,r,t){return t.indexOf(e)===r};return this.filter(e)}}),Object.defineProperty(Object.prototype,"glaem_each",{enumerable:!1,value:function(e){for(var r in this)if(this.hasOwnProperty(r)){var t=e(r,this[r]);if(0==t)break}}}),Object.defineProperty(Object.prototype,"glaem_each_reversed",{enumerable:!1,value:function(e){if(!this instanceof Array)return this.glaem_each(e);for(var r=this.length-1;r>=0;r--)if(this.hasOwnProperty(r)){var t=e(r,this[r]);if(0==t)break}}}),Object.defineProperty(Object.prototype,"glaem_merge",{enumerable:!1,value:function(e){var r={};for(var t in this)this.hasOwnProperty(t)&&(r[t]=this[t]);for(var t in e)e.hasOwnProperty(t)&&(r[t]=e[t]);return r}});var Glaemscribe={};Glaemscribe.WORD_BREAKER="|",Glaemscribe.WORD_BOUNDARY="_",Glaemscribe.UNKNOWN_CHAR_OUTPUT="\u2620",Glaemscribe.VIRTUAL_CHAR_OUTPUT="\u2622",Glaemscribe.ResourceManager=function(){return this.raw_modes={},this.raw_charsets={},this.loaded_modes={},this.loaded_charsets={},this.pre_processor_operator_classes={},this.post_processor_operator_classes={},this},Glaemscribe.ResourceManager.prototype.load_charsets=function(e){null==e&&(e=Object.keys(this.raw_charsets)),("string"==typeof e||e instanceof String)&&(e=[e]);for(var r=0;r<e.length;r++){var t=e[r];if(!this.loaded_charsets[t]&&this.raw_charsets[t]){var s=new Glaemscribe.CharsetParser,a=s.parse(t);a&&(this.loaded_charsets[t]=a)}}},Glaemscribe.ResourceManager.prototype.load_modes=function(e){null==e&&(e=Object.keys(this.raw_modes)),("string"==typeof e||e instanceof String)&&(e=[e]);for(var r=0;r<e.length;r++){var t=e[r];if(!this.loaded_modes[t]&&this.raw_modes[t]){var s=new Glaemscribe.ModeParser,a=s.parse(t);a&&(this.loaded_modes[t]=a)}}},Glaemscribe.ResourceManager.prototype.register_pre_processor_class=function(e,r){this.pre_processor_operator_classes[e]=r},Glaemscribe.ResourceManager.prototype.register_post_processor_class=function(e,r){this.post_processor_operator_classes[e]=r},Glaemscribe.ResourceManager.prototype.class_for_pre_processor_operator_name=function(e){return this.pre_processor_operator_classes[e]},Glaemscribe.ResourceManager.prototype.class_for_post_processor_operator_name=function(e){return this.post_processor_operator_classes[e]},Glaemscribe.resource_manager=new Glaemscribe.ResourceManager,Glaemscribe.Char=function(){return this},Glaemscribe.Char.prototype.is_virtual=function(){return!1},Glaemscribe.Char.prototype.output=function(){return this.str},Glaemscribe.VirtualChar=function(){return this.classes=[],this.lookup_table={},this.reversed=!1,this["default"]=null,this},Glaemscribe.VirtualChar.VirtualClass=function(){this.target="",this.triggers=[]},Glaemscribe.VirtualChar.prototype.is_virtual=function(){return!0},Glaemscribe.VirtualChar.prototype.output=function(){var e=this;return e["default"]?e.charset.n2c(e["default"]).output():Glaemscribe.VIRTUAL_CHAR_OUTPUT},Glaemscribe.VirtualChar.prototype.finalize=function(){var e=this;if(e.lookup_table={},e.classes.glaem_each(function(r,t){var s=t.target,a=t.triggers;a.glaem_each(function(r,t){var a=e.lookup_table[t];if(null!=a)e.charset.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Trigger char "+t+"found twice in virtual char."));else{var o=e.charset.n2c(s),i=e.charset.n2c(t);null==o?e.charset.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Trigger char "+t+" points to unknown result char "+s+".")):null==i?e.charset.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Unknown trigger char "+t+".")):o instanceof Glaemscribe.VirtualChar?e.charset.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Trigger char "+t+" points to another virtual char "+s+". This is not supported!")):i.names.glaem_each(function(r,t){e.lookup_table[t]=o})}})}),e["default"]){var r=e.charset.lookup_table[e["default"]];r?r.is_virtual()&&e.charset.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Default char "+e["default"]+" is virtual, it should be real only.")):e.charset.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Default char "+e["default"]+" does not match any real character in the charset."))}},Glaemscribe.VirtualChar.prototype.n2c=function(e){return this.lookup_table[e]},Glaemscribe.Charset=function(e){return this.name=e,this.chars=[],this.errors=[],this},Glaemscribe.Charset.prototype.add_char=function(e,r,t){if(void 0!=t&&0!=t.length&&-1==t.indexOf("?")){var s=new Glaemscribe.Char;s.line=e,s.code=r,s.names=t,s.str=String.fromCodePoint(r),s.charset=this,this.chars.push(s)}},Glaemscribe.Charset.prototype.add_virtual_char=function(e,r,t,s,a){if(void 0!=t&&0!=t.length&&-1==t.indexOf("?")){var o=new Glaemscribe.VirtualChar;o.line=e,o.names=t,o.classes=r,o.charset=this,o["default"]=a,o.reversed=s,this.chars.push(o)}},Glaemscribe.Charset.prototype.finalize=function(){var e=this;e.errors=[],e.lookup_table={},e.virtual_chars=[],e.chars=e.chars.sort(function(e,r){return e.is_virtual()&&r.is_virtual()?e.names[0].localeCompare(r.names[0]):e.is_virtual()?1:r.is_virtual()?-1:e.code-r.code});for(var r=0;r<e.chars.length;r++)for(var t=e.chars[r],s=0;s<t.names.length;s++){var a=t.names[s],o=e.lookup_table[a];null!=o?e.errors.push(new Glaemscribe.Glaeml.Error(t.line,"Character "+a+" found twice.")):e.lookup_table[a]=t}e.chars.glaem_each(function(r,t){t.is_virtual()&&(t.finalize(),e.virtual_chars.push(t))})},Glaemscribe.Charset.prototype.n2c=function(e){return this.lookup_table[e]},Glaemscribe.CharsetParser=function(){return this},Glaemscribe.CharsetParser.prototype.parse_raw=function(e,r){var t=new Glaemscribe.Charset(e),s=(new Glaemscribe.Glaeml.Parser).parse(r);if(s.errors.length>0)return t.errors=s.errors,t;for(var a=s.root_node.gpath("char"),o=0;o<a.length;o++){var i=a[o];code=parseInt(i.args[0],16),names=i.args.slice(1),t.add_char(i.line,code,names)}return s.root_node.gpath("virtual").glaem_each(function(e,r){var s=r.args,a=[],o=!1,i=null;r.gpath("class").glaem_each(function(e,r){var t=new Glaemscribe.VirtualChar.VirtualClass;t.target=r.args[0],t.triggers=r.args.slice(1),a.push(t)}),r.gpath("reversed").glaem_each(function(){o=!0}),r.gpath("default").glaem_each(function(e,r){i=r.args[0]}),t.add_virtual_char(r.line,a,s,o,i)}),t.finalize(),t},Glaemscribe.CharsetParser.prototype.parse=function(e){var r=Glaemscribe.resource_manager.raw_charsets[e];return this.parse_raw(e,r)},Glaemscribe.Glaeml={},Glaemscribe.Glaeml.Document=function(){return this.errors=[],this.root_node=null,this},Glaemscribe.Glaeml.NodeType={},Glaemscribe.Glaeml.NodeType.Text=0,Glaemscribe.Glaeml.NodeType.ElementInline=1,Glaemscribe.Glaeml.NodeType.ElementBlock=2,Glaemscribe.Glaeml.Node=function(e,r,t){return this.type=r,this.name=t,this.line=e,this.args=[],this.children=[],this},Glaemscribe.Glaeml.Node.prototype.clone=function(){var e=new Glaemscribe.Glaeml.Node(this.line,this.type,this.name);return e.args=this.args.slice(0),this.children.glaem_each(function(r,t){e.children.push(t.clone())}),e},Glaemscribe.Glaeml.Node.prototype.is_text=function(){return this.type==Glaemscribe.Glaeml.NodeType.Text},Glaemscribe.Glaeml.Node.prototype.is_element=function(){return this.type==Glaemscribe.Glaeml.NodeType.ElementInline||this.type==Glaemscribe.Glaeml.NodeType.ElementBlock},Glaemscribe.Glaeml.Node.prototype.pathfind_crawl=function(e,r){for(var t=this,s=0;s<t.children.length;s++){var a=t.children[s];if(a.name==e[0])if(1==e.length)r.push(a);else{var o=e.slice(0);o.shift(),a.pathfind_crawl(o,r)}}},Glaemscribe.Glaeml.Node.prototype.gpath=function(e){var r=e.split("."),t=[];return this.pathfind_crawl(r,t),t},Glaemscribe.Glaeml.Error=function(e,r){return this.line=e,this.text=r,this},Glaemscribe.Glaeml.Parser=function(){},Glaemscribe.Glaeml.Parser.prototype.add_text_node=function(e,r){var t=new Glaemscribe.Glaeml.Node(e,Glaemscribe.Glaeml.NodeType.Text,null);t.args.push(r),t.parent_node=this.current_parent_node,this.current_parent_node.children.push(t)},Glaemscribe.Glaeml.Parser.prototype.parse=function(e){e=e.replace(/\r/g,""),e=e.replace(/\\\*\*([\s\S]*?)\*\*\\/gm,function(e){return new Array((e.match(/\n/g)||[]).length+1).join("\n")});var r=0,t=this,s=new Glaemscribe.Glaeml.Document;s.root_node=new Glaemscribe.Glaeml.Node(r,Glaemscribe.Glaeml.NodeType.ElementBlock,"root"),t.current_parent_node=s.root_node;for(var a=e.split("\n"),o=0;o<a.length;o++){r+=1;var i=a[o];if(i=i.trim(),""!=i)if("\\"==i[0])if(1==i.length)s.errors.push(new Glaemscribe.Glaeml.Error(r,"Incomplete Node"));else{var n=null;if("\\"==i[1])t.add_text_node(r,i.substring(1));else if(n=i.match(/^(\\beg\s+)/)){var l=n[0],c=i.substring(l.length),p=[],u="???";if(n=c.match(/^([a-z_]+)/)){u=n[0];try{p=shellwords.split(c.substring(u.length))}catch(h){s.errors.push(new Glaemscribe.Glaeml.Error(r,"Error parsing args ("+h+")."))}}else s.errors.push(new Glaemscribe.Glaeml.Error(r,"Bad element name."));var m=new Glaemscribe.Glaeml.Node(r,Glaemscribe.Glaeml.NodeType.ElementBlock,u);m.args=m.args.concat(p),m.parent_node=t.current_parent_node,t.current_parent_node.children.push(m),t.current_parent_node=m}else if(n=i.match(/^(\\end(\s|$))/))t.current_parent_node.parent_node?""!=i.substring(n[0].length).trim()?s.errors.push(new Glaemscribe.Glaeml.Error(r,"Element 'end' should not have any argument.")):t.current_parent_node=t.current_parent_node.parent_node:s.errors.push(new Glaemscribe.Glaeml.Error(r,"Element 'end' unexpected."));else if(i=i.substring(1),n=i.match(/^([a-z_]+)/)){var u=n[0],p=[];try{p=shellwords.split(i.substring(u.length))}catch(h){s.errors.push(new Glaemscribe.Glaeml.Error(r,"Error parsing args ("+h+")."))}m=new Glaemscribe.Glaeml.Node(r,Glaemscribe.Glaeml.NodeType.ElementInline,u),m.args=m.args.concat(p),m.parent_node=t.current_parent_node,t.current_parent_node.children.push(m)}else s.errors.push(new Glaemscribe.Glaeml.Error(r,"Cannot understand element name."))}else t.add_text_node(r,i);else t.add_text_node(r,i)}return t.current_parent_node!=s.root_node&&s.errors.push(new Glaemscribe.Glaeml.Error(r,"Missing 'end' element.")),s},Glaemscribe.Fragment=function(e,r){var t=this;if(t.sheaf=e,t.mode=e.mode,t.rule=e.rule,t.expression=r,t.equivalences=stringListToCleanArray(t.expression,Glaemscribe.Fragment.EQUIVALENCE_RX_OUT),t.equivalences=t.equivalences.map(function(e){var r=e,s=Glaemscribe.Fragment.EQUIVALENCE_RX_IN.exec(e);return s?(r=s[1],r=r.split(Glaemscribe.Fragment.EQUIVALENCE_SEPARATOR).map(function(e){return e=e.trim(),""==e?void t.rule.errors.push("Null members are not allowed in equivalences!"):e.split(/\s/)})):r=[e.split(/\s/)],r}),0==t.equivalences.length&&(t.equivalences=[[[""]]]),t.is_dst())for(var s=t.sheaf.mode,a=0;a<t.equivalences.length;a++)for(var o=t.equivalences[a],i=0;i<o.length;i++)for(var n=o[i],l=0;l<n.length;l++){var c=n[l];if(""!=c)for(var p in s.supported_charsets){var u=s.supported_charsets[p],h=u.n2c(c);if(null==h)return void t.rule.errors.push("Symbol '"+c+"' not found in charset '"+u.name+"'!")}}for(var m=t.equivalences[0],a=0;a<t.equivalences.length-1;a++){var _=m.productize(t.equivalences[a+1]);m=_.map(function(e){var r=e[0],t=e[1];return r.concat(t)})}t.combinations=m},Glaemscribe.Fragment.EQUIVALENCE_SEPARATOR=",",Glaemscribe.Fragment.EQUIVALENCE_RX_OUT=/(\(.*?\))/,Glaemscribe.Fragment.EQUIVALENCE_RX_IN=/\((.*?)\)/,Glaemscribe.Fragment.prototype.is_src=function(){return this.sheaf.is_src()},Glaemscribe.Fragment.prototype.is_dst=function(){return this.sheaf.is_dst()},Glaemscribe.ModeDebugContext=function(){return this.preprocessor_output="",this.processor_pathes=[],this.processor_output=[],this.postprocessor_output="",this},Glaemscribe.Mode=function(e){return this.name=e,this.supported_charsets={},this.options={},this.errors=[],this.warnings=[],this.latest_option_values={},this.pre_processor=new Glaemscribe.TranscriptionPreProcessor(this),this.processor=new Glaemscribe.TranscriptionProcessor(this),this.post_processor=new Glaemscribe.TranscriptionPostProcessor(this),this},Glaemscribe.Mode.prototype.finalize=function(e){var r=this;null==e&&(e={});var t={};r.options.glaem_each(function(e,r){t[e]=r.default_value_name}),e.glaem_each(function(e,s){var a=r.options[e];if(!a)return!0;var o=a.value_for_value_name(s);return null==o?!0:void(t[e]=s)});var s={};return t.glaem_each(function(e,t){s[e]=r.options[e].value_for_value_name(t)}),r.options.glaem_each(function(e,r){r.type==Glaemscribe.Option.Type.ENUM&&r.values.glaem_each(function(e,r){s[e]=r})}),this.latest_option_values=s,this.pre_processor.finalize(this.latest_option_values),this.post_processor.finalize(this.latest_option_values),this.processor.finalize(this.latest_option_values),this},Glaemscribe.Mode.prototype.transcribe=function(e,r){var t=new Glaemscribe.ModeDebugContext;if(null==r&&(r=this.default_charset),null==r)return[!1,"*** No charset usable for transcription. Failed!"];for(var s="",a=e.split("\n"),o=0;o<a.length;o++){var i=a[o].trim();i=this.pre_processor.apply(i),t.preprocessor_output+=i+"\n",i=this.processor.apply(i,t),t.processor_output=t.processor_output.concat(i),i=this.post_processor.apply(i,r),t.postprocessor_output+=i+"\n",s+=i+"\n"}return[!0,s,t]},Glaemscribe.Option=function(e,r,t,s,a){return this.mode=e,this.name=r,this.default_value_name=t,this.type=0==Object.keys(s).length?Glaemscribe.Option.Type.BOOL:Glaemscribe.Option.Type.ENUM,this.values=s,this.visibility=a,this},Glaemscribe.Option.Type={},Glaemscribe.Option.Type.BOOL="BOOL",Glaemscribe.Option.Type.ENUM="ENUM",Glaemscribe.Option.prototype.default_value=function(){return this.type==Glaemscribe.Option.Type.BOOL?"true"==this.default_value_name:this.values[this.default_value_name]},Glaemscribe.Option.prototype.value_for_value_name=function(e){return this.type==Glaemscribe.Option.Type.BOOL?"true"==e||1==e?!0:"false"==e||0==e?!1:null:this.values[e]},Glaemscribe.Option.prototype.is_visible=function(){var e=new Glaemscribe.Eval.Parser,r=!1;try{return r=e.parse(this.visibility||"true",this.mode.latest_option_values||{}),1==r}catch(t){return console.log(t),null}},Glaemscribe.ModeParser=function(){return this},Glaemscribe.ModeParser.prototype.validate_presence_of_args=function(e,r){var t=this;null!=r&&e.args.length!=r&&t.mode.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Element '"+e.name+"' should have "+r+" arguments."))},Glaemscribe.ModeParser.prototype.validate_presence_of_children=function(e,r,t,s){var a=this,o=e.gpath(r);t&&o.length!=t&&a.mode.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Element '"+e.name+"' should have exactly "+t+" children of type '"+r+"'.")),s&&o.glaem_each(function(e,r){a.validate_presence_of_args(r,s)})},Glaemscribe.ModeParser.prototype.verify_mode_glaeml=function(e){var r=this;r.validate_presence_of_children(e.root_node,"language",1,1),r.validate_presence_of_children(e.root_node,"writing",1,1),r.validate_presence_of_children(e.root_node,"mode",1,1),r.validate_presence_of_children(e.root_node,"authors",1,1),r.validate_presence_of_children(e.root_node,"version",1,1),e.root_node.gpath("charset").glaem_each(function(e,t){r.validate_presence_of_args(t,2)}),e.root_node.gpath("options.option").glaem_each(function(e,t){r.validate_presence_of_args(t,2),t.gpath("value").glaem_each(function(e,t){r.validate_presence_of_args(t,2)})}),e.root_node.gpath("outspace").glaem_each(function(e,t){r.validate_presence_of_args(t,1)}),e.root_node.gpath("processor.rules").glaem_each(function(e,t){r.validate_presence_of_args(t,1),r.validate_presence_of_children(t,"if",null,1),r.validate_presence_of_children(t,"elsif",null,1)}),e.root_node.gpath("preprocessor.if").glaem_each(function(e,t){r.validate_presence_of_args(t,1)}),e.root_node.gpath("preprocessor.elsif").glaem_each(function(e,t){r.validate_presence_of_args(t,1)}),e.root_node.gpath("postprocessor.if").glaem_each(function(e,t){r.validate_presence_of_args(t,1)}),e.root_node.gpath("postprocessor.elsif").glaem_each(function(e,t){r.validate_presence_of_args(t,1)})},Glaemscribe.ModeParser.prototype.create_if_cond_for_if_term=function(e,r,t){var s=new Glaemscribe.IfTree.IfCond(e,r,t),a=new Glaemscribe.IfTree.CodeBlock(s);return s.child_code_block=a,r.if_conds.push(s),s},Glaemscribe.ModeParser.prototype.traverse_if_tree=function(e,r,t,s){for(var a=this.mode,o=e,i=0;i<r.children.length;i++){var n=r.children[i];if(n.is_text())null!=t&&t(o,n);else if(n.is_element())switch(n.name){case"if":var l=n.args[0],c=new Glaemscribe.IfTree.IfTerm(o);o.terms.push(c);var p=this.create_if_cond_for_if_term(n.line,c,l);o=p.child_code_block;break;case"elsif":var l=n.args[0],c=o.parent_if_cond.parent_if_term;if(null==c)return void a.errors.push(new Glaemscribe.Glaeml.Error(n.line,"'elsif' without a 'if'."));var p=this.create_if_cond_for_if_term(n.line,c,l);o=p.child_code_block;break;case"else":var c=o.parent_if_cond.parent_if_term;if(null==c)return void a.errors.push(new Glaemscribe.Glaeml.Error(n.line,"'else' without a 'if'."));var p=this.create_if_cond_for_if_term(n.line,c,"true");o=p.child_code_block;break;case"endif":var c=o.parent_if_cond.parent_if_term;if(null==c)return void a.errors.push(new Glaemscribe.Glaeml.Error(n.line,"'endif' without a 'if'."));o=c.parent_code_block;break;default:null!=s&&s(o,n)}}o.parent_if_cond&&a.errors.push(new Glaemscribe.Glaeml.Error(n.line,"Unended 'if' at the end of this '"+r.name+"' element."))},Glaemscribe.ModeParser.prototype.parse_pre_post_processor=function(e,r){var t=this.mode,s=function(){},a=function(e,s){var a=e.terms[e.terms.length-1];null!=a&&a.is_pre_post_processor_operators()||(a=new Glaemscribe.IfTree.PrePostProcessorOperatorsTerm(e),e.terms.push(a));var o=s.name,i=null;i=r?Glaemscribe.resource_manager.class_for_pre_processor_operator_name(o):Glaemscribe.resource_manager.class_for_post_processor_operator_name(o),i?a.operators.push(new i(s.clone())):t.errors.push(new Glaemscribe.Glaeml.Error(s.line,"Operator '"+o+"' is unknown."))},o=r?t.pre_processor.root_code_block:t.post_processor.root_code_block;this.traverse_if_tree(o,e,s,a)},Glaemscribe.ModeParser.prototype.parse_raw=function(e,r,t){var s=new Glaemscribe.Mode(e);if(this.mode=s,s.raw=r,null==r)return s.errors.push(new Glaemscribe.Glaeml.Error(0,"No sourcecode. Forgot to load it?")),s;null==t&&(t={});var a=(new Glaemscribe.Glaeml.Parser).parse(r);if(a.errors.length>0)return s.errors=a.errors,s;if(this.verify_mode_glaeml(a),s.errors.length>0)return s;s.language=a.root_node.gpath("language")[0].args[0],s.writing=a.root_node.gpath("writing")[0].args[0],s.human_name=a.root_node.gpath("mode")[0].args[0],s.authors=a.root_node.gpath("authors")[0].args[0],s.version=a.root_node.gpath("version")[0].args[0],a.root_node.gpath("options.option").glaem_each(function(e,r){var t={},a=null;r.gpath("value").glaem_each(function(e,r){var s=r.args[0];t[s]=parseInt(r.args[1])}),r.gpath("visible_when").glaem_each(function(e,r){a=r.args[0]});var o=r.args[0],i=r.args[1];null==i&&s.errors.push(new Glaemscribe.Glaeml.Error(r.line,"Missing option 'default' value.")),option=new Glaemscribe.Option(s,o,i,t,a),s.options[option.name]=option});for(var o=a.root_node.gpath("charset"),i=0;i<o.length;i++){var n=o[i],l=n.args[0],c=Glaemscribe.resource_manager.loaded_charsets[l];if(c||(Glaemscribe.resource_manager.load_charsets([l]),c=Glaemscribe.resource_manager.loaded_charsets[l]),c){if(c.errors.length>0){for(var p=0;p<c.errors.length;p++){var u=c.errors[p];s.errors.push(new Glaemscribe.Glaeml.Error(n.line,l+":"+u.line+":"+u.text))}return s}s.supported_charsets[l]=c;var h=n.args[1];h&&"true"==h&&(s.default_charset=c)}else s.warnings.push(new Glaemscribe.Glaeml.Error(n.line,"Failed to load charset '"+l+"'."))}s.default_charset||s.warnings.push(new Glaemscribe.Glaeml.Error(0,"No default charset defined!!"));var m=a.root_node.gpath("preprocessor")[0];m&&this.parse_pre_post_processor(m,!0);var _=a.root_node.gpath("postprocessor")[0];_&&this.parse_pre_post_processor(_,!1);var f=a.root_node.gpath("outspace")[0];if(f){var b=f.args[0];s.post_processor.out_space=stringListToCleanArray(b,/\s/)}for(var d=a.root_node.gpath("processor.rules"),G=0;G<d.length;G++){var v=d[G],g=v.args[0],P=new Glaemscribe.RuleGroup(s,g);s.processor.rule_groups[g]=P;var y=function(e,r){var t=e.terms[e.terms.length-1];null!=t&&t.is_code_lines()||(t=new Glaemscribe.IfTree.CodeLinesTerm(e),e.terms.push(t));for(var s=r.line,a=r.args[0].split("\n"),o=0;o<a.length;o++){var i=a[o].trim(),n=new Glaemscribe.IfTree.CodeLine(i,s);t.code_lines.push(n),s+=1}},w=function(e,r){s.errors.push(new Glaemscribe.Glaeml.Error(r.line,"Unknown directive "+r.name+"."))};this.traverse_if_tree(P.root_code_block,v,y,w)}return 0==s.errors.length&&s.finalize(t),s},Glaemscribe.ModeParser.prototype.parse=function(e){var r=this,t=Glaemscribe.resource_manager.raw_modes[e];return r.parse_raw(e,t)},Glaemscribe.Rule=function(e,r){this.line=e,this.rule_group=r,this.mode=r.mode,this.sub_rules=[],this.errors=[]},Glaemscribe.Rule.prototype.finalize=function(e){if(this.errors.length>0)for(var r=0;r<this.errors.length;r++){var t=this.errors[r];this.mode.errors.push(new Glaemscribe.Glaeml.Error(this.line,t))}else{var s=new Glaemscribe.SheafChainIterator(this.src_sheaf_chain),a=new Glaemscribe.SheafChainIterator(this.dst_sheaf_chain,e);if(s.errors.length>0)for(var r=0;r<s.errors.length;r++){var t=s.errors[r];this.mode.errors.push(new Glaemscribe.Glaeml.Error(this.line,t))}else if(a.errors.length>0)for(var r=0;r<a.errors.length;r++){var t=a.errors[r];this.mode.errors.push(new Glaemscribe.Glaeml.Error(this.line,t))}else{var o=s.proto(),i=a.proto();if(o!=i)return void this.mode.errors.push(new Glaemscribe.Glaeml.Error(this.line,"Source and destination are not compatible ("+o+" vs "+i+")"));do{for(var n=s.combinations(),l=a.combinations()[0],c=0;c<n.length;c++){var p=n[c];this.sub_rules.push(new Glaemscribe.SubRule(this,p,l))}a.iterate()}while(s.iterate())}}},Glaemscribe.RuleGroup=function(e,r){return this.name=r,this.mode=e,this.root_code_block=new Glaemscribe.IfTree.CodeBlock,this},Glaemscribe.RuleGroup.VAR_NAME_REGEXP=/{([0-9A-Z_]+)}/g,Glaemscribe.RuleGroup.prototype.add_var=function(e,r){this.vars[e]=r},Glaemscribe.RuleGroup.prototype.apply_vars=function(e,r){var t=this,s=this.mode,a=!1,o=r.replace(Glaemscribe.RuleGroup.VAR_NAME_REGEXP,function(o,i){var n=t.vars[i];return null==n?(s.errors.push(new Glaemscribe.Glaeml.Error(e,"In expression: "+r+": failed to evaluate variable: "+i+".")),a=!0,""):n});return a?null:o},Glaemscribe.RuleGroup.prototype.descend_if_tree=function(e,r){for(var t=this.mode,s=0;s<e.terms.length;s++){var a=e.terms[s];if(a.is_code_lines())for(var o=0;o<a.code_lines.length;o++){var i=a.code_lines[o];this.finalize_code_line(i)}else for(var n=0;n<a.if_conds.length;n++){var l=a.if_conds[n],c=new Glaemscribe.Eval.Parser,p=!1;try{p=c.parse(l.expression,r)}catch(u){t.errors.push(new Glaemscribe.Glaeml.Error(l.line,"Failed to evaluate condition '"+l.expression+"'."))}if(1==p){this.descend_if_tree(l.child_code_block,r);break}}}},Glaemscribe.RuleGroup.VAR_DECL_REGEXP=/^\s*{([0-9A-Z_]+)}\s+===\s+(.+?)\s*$/,Glaemscribe.RuleGroup.RULE_REGEXP=/^\s*(.*?)\s+-->\s+(.+?)\s*$/,Glaemscribe.RuleGroup.CROSS_RULE_REGEXP=/^\s*(.*?)\s+-->\s+([\s0-9,]+)\s+-->\s+(.+?)\s*$/,Glaemscribe.RuleGroup.prototype.finalize_rule=function(e,r,t,s){var a=this.apply_vars(e,r),o=this.apply_vars(e,t);if(null!=a&&null!=o){var i=new Glaemscribe.Rule(e,this);i.src_sheaf_chain=new Glaemscribe.SheafChain(i,a,!0),i.dst_sheaf_chain=new Glaemscribe.SheafChain(i,o,!1),i.finalize(s),this.rules.push(i)}},Glaemscribe.RuleGroup.prototype.finalize_code_line=function(e){var r=this.mode;if(exp=Glaemscribe.RuleGroup.VAR_DECL_REGEXP.exec(e.expression)){var t=exp[1],s=exp[2],a=this.apply_vars(e.line,s);if(null==a)return void r.errors.push(new Glaemscribe.Glaeml.Error(e.line,"Thus, variable {"+t+"} could not be declared."));this.add_var(t,a)}else if(exp=Glaemscribe.RuleGroup.CROSS_RULE_REGEXP.exec(e.expression)){var o=exp[1],i=exp[2],n=exp[3];this.finalize_rule(e.line,o,n,i)}else if(exp=Glaemscribe.RuleGroup.RULE_REGEXP.exec(e.expression)){var o=exp[1],n=exp[2];this.finalize_rule(e.line,o,n)}else""==e.expression||r.errors.push(new Glaemscribe.Glaeml.Error(e.line,": Cannot understand '"+e.expression+"'."))},Glaemscribe.RuleGroup.prototype.finalize=function(e){var r=this;this.vars={},this.in_charset={},this.rules=[],this.add_var("NULL",""),this.descend_if_tree(this.root_code_block,e),r.in_charset={};for(var t=0;t<r.rules.length;t++)for(var s=r.rules[t],a=0;a<s.sub_rules.length;a++)for(var o=s.sub_rules[a],i=o.src_combination.join("").split(""),n=0;n<i.length;n++){var l=i[n];l!=Glaemscribe.WORD_BREAKER&&l!=Glaemscribe.WORD_BOUNDARY&&(r.in_charset[l]=r)}},Glaemscribe.SubRule=function(e,r,t){this.src_combination=r,this.dst_combination=t},Glaemscribe.Sheaf=function(e,r){var t=this;t.sheaf_chain=e,t.mode=e.mode,t.rule=e.rule,t.expression=r,t.fragment_exps=r.split(Glaemscribe.Sheaf.SHEAF_SEPARATOR).map(function(e){return e.trim()}),0==t.fragment_exps.length&&(t.fragment_exps=[""]),t.fragments=t.fragment_exps.map(function(e){return new Glaemscribe.Fragment(t,e)})},Glaemscribe.Sheaf.SHEAF_SEPARATOR="*",Glaemscribe.Sheaf.prototype.is_src=function(){return this.sheaf_chain.is_src},Glaemscribe.Sheaf.prototype.is_dst=function(){return!this.sheaf_chain.is_src},Glaemscribe.Sheaf.prototype.mode=function(){return this.sheaf_chain.mode()},Glaemscribe.SheafChain=function(e,r,t){var s=this;return s.rule=e,s.mode=e.mode,s.is_src=t,s.expression=r,s.sheaf_exps=stringListToCleanArray(r,Glaemscribe.SheafChain.SHEAF_REGEXP_OUT),s.sheaf_exps=s.sheaf_exps.map(function(e){var r=Glaemscribe.SheafChain.SHEAF_REGEXP_IN.exec(e);return r&&(e=r[1]),e.trim()}),s.sheaves=s.sheaf_exps.map(function(e){return new Glaemscribe.Sheaf(s,e)}),0==s.sheaves.length&&(s.sheaves=[new Glaemscribe.Sheaf(s,"")]),s},Glaemscribe.SheafChain.SHEAF_REGEXP_IN=/\[(.*?)\]/,Glaemscribe.SheafChain.SHEAF_REGEXP_OUT=/(\[.*?\])/,Glaemscribe.SheafChain.prototype.mode=function(){return this.rule.mode()},Glaemscribe.SheafChainIterator=function(e,r){var t=this;t.sheaf_chain=e,t.sizes=e.sheaves.map(function(e){return e.fragments.length}),t.iterators=t.sizes.map(function(){return 0}),t.errors=[];for(var s=[],a=e.sheaves.length,o=0;a>o;o++)s.push(o+1);var i=null;if(null!=r){i=r.split(",").map(function(e){return parseInt(e)});var n=i.length;n!=a&&t.errors.push(a+" sheaves found in right predicate, but "+n+" elements in cross rule.");var l=i.slice(0);s.equals(l.sort())||t.errors.push("Cross rule should contain each element of "+s+" once and only once.")}else i=s;this.cross_array=i},Glaemscribe.SheafChainIterator.prototype.proto=function(){for(var e=this,r=e.sizes.slice(0),t=e.sizes.slice(0),s=0;s<r.length;s++)t[s]=r[e.cross_array[s]-1];return r=t.filter(function(e){return 1!=e}),r=r.join("x"),""==r&&(r="1"),r},Glaemscribe.SheafChainIterator.prototype.combinations=function(){for(var e=this,r=[],t=0;t<e.iterators.length;t++){var s=e.iterators[t],a=e.sheaf_chain.sheaves[t],o=a.fragments[s];r.push(o.combinations)}for(var i=r[0],t=0;t<r.length-1;t++){var n=i.productize(r[t+1]);i=n.map(function(e){var r=e[0],t=e[1];return r.concat(t)})}return i},Glaemscribe.SheafChainIterator.prototype.iterate=function(){for(var e=this,r=0;r<e.sizes.length;){var t=e.cross_array[r]-1;if(e.iterators[t]+=1,!(e.iterators[t]>=e.sizes[t]))return!0;e.iterators[t]=0,r+=1}return!1},Glaemscribe.IfTree={},Glaemscribe.IfTree.IfCond=function(e,r,t){return this.line=e,this.parent_if_term=r,this.expression=t,this},Glaemscribe.IfTree.Term=function(e){return this.parent_code_block=e,this},Glaemscribe.IfTree.Term.prototype.is_code_lines=function(){return!1},Glaemscribe.IfTree.Term.prototype.is_pre_post_processor_operators=function(){return!1},Glaemscribe.IfTree.Term.prototype.name=function(){return"TERM"},Glaemscribe.IfTree.Term.prototype.dump=function(e){for(var r="",t=0;e>t;t++)r+=" ";r+="|-"+this.name(),console.log(r)},Glaemscribe.IfTree.IfTerm=function(e){return Glaemscribe.IfTree.Term.call(this,e),this.if_conds=[],this},Glaemscribe.IfTree.IfTerm.inheritsFrom(Glaemscribe.IfTree.Term),Glaemscribe.IfTree.IfTerm.prototype.name=function(){return"IF_TERM"},Glaemscribe.IfTree.IfTerm.prototype.dump=function(e){this.parent.dump.call(this,e)},Glaemscribe.IfTree.CodeLine=function(e,r){return this.expression=e,this.line=r,this},Glaemscribe.IfTree.PrePostProcessorOperatorsTerm=function(e){return Glaemscribe.IfTree.Term.call(this,e),this.operators=[],this},Glaemscribe.IfTree.PrePostProcessorOperatorsTerm.inheritsFrom(Glaemscribe.IfTree.Term),Glaemscribe.IfTree.PrePostProcessorOperatorsTerm.prototype.name=function(){return"OP_TERM"},Glaemscribe.IfTree.PrePostProcessorOperatorsTerm.prototype.is_pre_post_processor_operators=function(){return!0},Glaemscribe.IfTree.CodeLinesTerm=function(e){return Glaemscribe.IfTree.Term.call(this,e),this.code_lines=[],this},Glaemscribe.IfTree.CodeLinesTerm.inheritsFrom(Glaemscribe.IfTree.Term),Glaemscribe.IfTree.CodeLinesTerm.prototype.name=function(){return"CL_TERM"},Glaemscribe.IfTree.CodeLinesTerm.prototype.is_code_lines=function(){return!0},Glaemscribe.IfTree.CodeBlock=function(e){return this.parent_if_cond=e,this.terms=[],this},Glaemscribe.IfTree.CodeBlock.prototype.dump=function(e){for(var r="",t=0;e>t;t++)r+=" ";r+="|-BLOCK",console.log(r);for(var s=0;s<this.terms.length;s++)this.terms[s].dump(e+1)},Glaemscribe.Eval={},Glaemscribe.Eval.Token=function(e,r){this.name=e,this.expression=r},Glaemscribe.Eval.Token.prototype.is_regexp=function(){return this.expression instanceof RegExp},Glaemscribe.Eval.Token.prototype.clone=function(e){var r=new Glaemscribe.Eval.Token(this.name,this.expression);return r.value=e,r},Glaemscribe.Eval.Lexer=function(e){this.exp=e,this.token_chain=[],this.retain_last=!1},Glaemscribe.Eval.Lexer.prototype.uneat=function(){this.retain_last=!0},Glaemscribe.Eval.Lexer.prototype.EXP_TOKENS=[new Glaemscribe.Eval.Token("bool_or","||"),new Glaemscribe.Eval.Token("bool_and","&&"),new Glaemscribe.Eval.Token("cond_inf_eq","<="),new Glaemscribe.Eval.Token("cond_inf","<"),new Glaemscribe.Eval.Token("cond_sup_eq",">="),new Glaemscribe.Eval.Token("cond_sup",">"),new Glaemscribe.Eval.Token("cond_eq","=="),new Glaemscribe.Eval.Token("cond_not_eq","!="),new Glaemscribe.Eval.Token("add_plus","+"),new Glaemscribe.Eval.Token("add_minus","-"),new Glaemscribe.Eval.Token("mult_times","*"),new Glaemscribe.Eval.Token("mult_div","/"),new Glaemscribe.Eval.Token("mult_modulo","%"),new Glaemscribe.Eval.Token("prim_not","!"),new Glaemscribe.Eval.Token("prim_lparen","("),new Glaemscribe.Eval.Token("prim_rparen",")"),new Glaemscribe.Eval.Token("prim_string",/^'[^']*'/),new Glaemscribe.Eval.Token("prim_string",/^"[^"]*"/),new Glaemscribe.Eval.Token("prim_const",/^[a-zA-Z0-9_.]+/)],Glaemscribe.Eval.Lexer.prototype.TOKEN_END=new Glaemscribe.Eval.Token("prim_end",""),Glaemscribe.Eval.Lexer.prototype.advance=function(){if(this.exp=this.exp.trim(),1==this.retain_last)return this.retain_last=!1,this.token_chain[this.token_chain.length-1];if(this.exp==Glaemscribe.Eval.Lexer.prototype.TOKEN_END.expression){var e=Glaemscribe.Eval.Lexer.prototype.TOKEN_END.clone("");return this.token_chain.push(e),e}for(var e=0;e<Glaemscribe.Eval.Lexer.prototype.EXP_TOKENS.length;e++){var r=Glaemscribe.Eval.Lexer.prototype.EXP_TOKENS[e];if(r.is_regexp()){var t=this.exp.match(r.expression);if(t){var s=t[0];this.exp=this.exp.substring(s.length);var e=r.clone(s);return this.token_chain.push(e),e}}else if(0==this.exp.indexOf(r.expression)){
this.exp=this.exp.substring(r.expression.length);var e=r.clone(r.expression);return this.token_chain.push(e),e}}throw"UnknownToken"},Glaemscribe.Eval.Parser=function(){},Glaemscribe.Eval.Parser.prototype.parse=function(e,r){return this.lexer=new Glaemscribe.Eval.Lexer(e),this.vars=r,this.parse_top_level()},Glaemscribe.Eval.Parser.prototype.parse_top_level=function(){return this.explore_bool()},Glaemscribe.Eval.Parser.prototype.explore_bool=function(){for(var e=this.explore_compare(),r=!1;!r;)switch(this.lexer.advance().name){case"bool_or":1==e?this.explore_bool():e=this.explore_compare();break;case"bool_and":1==!e?this.explore_bool():e=this.explore_compare();break;default:r=!0}return this.lexer.uneat(),e},Glaemscribe.Eval.Parser.prototype.explore_compare=function(){for(var e=this.explore_add(),r=!1;!r;)switch(this.lexer.advance().name){case"cond_inf_eq":e=e<=this.explore_add();break;case"cond_inf":e=e<this.explore_add();break;case"cond_sup_eq":e=e>=this.explore_add();break;case"cond_sup":e=e>this.explore_add();break;case"cond_eq":e=e==this.explore_add();break;case"cond_not_eq":e=e!=this.explore_add();break;default:r=!0}return this.lexer.uneat(),e},Glaemscribe.Eval.Parser.prototype.explore_add=function(){for(var e=this.explore_mult(),r=!1;!r;)switch(this.lexer.advance().name){case"add_plus":e+=this.explore_mult();break;case"add_minus":e-=this.explore_mult();break;default:r=!0}return this.lexer.uneat(),e},Glaemscribe.Eval.Parser.prototype.explore_mult=function(){for(var e=this.explore_primary(),r=!1;!r;)switch(this.lexer.advance().name){case"mult_times":e*=this.explore_primary();break;case"mult_div":e/=this.explore_primary();break;case"mult_modulo":e%=this.explore_primary();break;default:r=!0}return this.lexer.uneat(),e},Glaemscribe.Eval.Parser.prototype.explore_primary=function(){var e=this.lexer.advance(),r=null;switch(e.name){case"prim_const":r=this.cast_constant(e.value);break;case"add_minus":r=-this.explore_primary();break;case"prim_not":r=!this.explore_primary();break;case"prim_lparen":r=this.parse_top_level();var t=this.lexer.advance();if("prim_rparen"!=t.name)throw"Missing right parenthesis.";break;default:throw"Cannot understand: "+e.value+"."}return r},Glaemscribe.Eval.Parser.prototype.constant_is_float=function(e){return isNaN(e)?!1:Number(e)%1!==0},Glaemscribe.Eval.Parser.prototype.constant_is_int=function(e){return isNaN(e)?!1:Number(e)%1===0},Glaemscribe.Eval.Parser.prototype.constant_is_string=function(e){if(e.length<2)return!1;var r=e[0],t=e[e.length-1];return r==t&&("'"==t||'"'==t)},Glaemscribe.Eval.Parser.prototype.cast_constant=function(e){var r=null;if(this.constant_is_int(e))return parseInt(e);if(this.constant_is_float(e))return parseFloat(e);if(r=e.match(/^\'(.*)\'$/))return r[0];if(r=e.match(/^\"(.*)\"$/))return r[0];if("true"==e)return!0;if("false"==e)return!1;if("nil"==e)return null;if(null!=this.vars[e])return this.vars[e];throw"Cannot understand constant '"+e+"'."},Glaemscribe.TranscriptionTreeNode=function(e,r,t){var s=this;s.character=e,s.replacement=r,s.path=t,s.siblings={}},Glaemscribe.TranscriptionTreeNode.prototype.is_effective=function(){return null!=this.replacement},Glaemscribe.TranscriptionTreeNode.prototype.add_subpath=function(e,r,t){if(null!=e&&""!=e){var s=this,a=e[0],o=s.siblings[a],i=(t||"")+a;null==o&&(o=new Glaemscribe.TranscriptionTreeNode(a,null,i)),s.siblings[a]=o,1==e.length?o.replacement=r:o.add_subpath(e.substring(1),r,i)}},Glaemscribe.TranscriptionTreeNode.prototype.transcribe=function(e,r){if(null==r&&(r=[]),r.push(this),""!=e){var t=e[0],s=this.siblings[t];if(s)return s.transcribe(e.substring(1),r)}for(;r.length>1;){var a=r.pop();if(a.is_effective())return[a.replacement,r.length]}return[["*UNKNOWN"],1]},Glaemscribe.PrePostProcessorOperator=function(e){return this.glaeml_element=e,this},Glaemscribe.PrePostProcessorOperator.prototype.apply=function(){throw"Pure virtual method, should be overloaded."},Glaemscribe.PrePostProcessorOperator.prototype.eval_arg=function(e,r){if(null==e)return null;var t=null;return(t=e.match(/^\\eval\s/))?(to_eval=e.substring(t[0].length),(new Glaemscribe.Eval.Parser).parse(to_eval,r)):e},Glaemscribe.PrePostProcessorOperator.prototype.finalize_glaeml_element=function(e,r){for(var t=this,s=0;s<e.args.length;s++)e.args[s]=t.eval_arg(e.args[s],r);return e.children.glaem_each(function(e,s){t.finalize_glaeml_element(s,r)}),e},Glaemscribe.PrePostProcessorOperator.prototype.finalize=function(e){var r=this;r.finalized_glaeml_element=r.finalize_glaeml_element(r.glaeml_element.clone(),e)},Glaemscribe.PreProcessorOperator=function(e){return Glaemscribe.PrePostProcessorOperator.call(this,e),this},Glaemscribe.PreProcessorOperator.inheritsFrom(Glaemscribe.PrePostProcessorOperator),Glaemscribe.PostProcessorOperator=function(e){return Glaemscribe.PrePostProcessorOperator.call(this,e),this},Glaemscribe.PostProcessorOperator.inheritsFrom(Glaemscribe.PrePostProcessorOperator),Glaemscribe.TranscriptionPrePostProcessor=function(e){return this.mode=e,this.root_code_block=new Glaemscribe.IfTree.CodeBlock,this},Glaemscribe.TranscriptionPrePostProcessor.prototype.finalize=function(e){this.operators=[],this.descend_if_tree(this.root_code_block,e),this.operators.glaem_each(function(r,t){t.finalize(e)})},Glaemscribe.TranscriptionPrePostProcessor.prototype.descend_if_tree=function(e,r){for(var t=0;t<e.terms.length;t++){var s=e.terms[t];if(s.is_pre_post_processor_operators())for(var a=0;a<s.operators.length;a++){var o=s.operators[a];this.operators.push(o)}else for(var i=0;i<s.if_conds.length;i++){var n=s.if_conds[i],l=new Glaemscribe.Eval.Parser;if(1==l.parse(n.expression,r)){this.descend_if_tree(n.child_code_block,r);break}}}},Glaemscribe.TranscriptionPreProcessor=function(e){return Glaemscribe.TranscriptionPrePostProcessor.call(this,e),this},Glaemscribe.TranscriptionPreProcessor.inheritsFrom(Glaemscribe.TranscriptionPrePostProcessor),Glaemscribe.TranscriptionPreProcessor.prototype.apply=function(e){for(var r=e,t=0;t<this.operators.length;t++){var s=this.operators[t];r=s.apply(r)}return r},Glaemscribe.TranscriptionPostProcessor=function(e){return Glaemscribe.TranscriptionPrePostProcessor.call(this,e),this},Glaemscribe.TranscriptionPostProcessor.inheritsFrom(Glaemscribe.TranscriptionPrePostProcessor),Glaemscribe.TranscriptionPostProcessor.prototype.apply=function(e,r){var t=" ";null!=this.out_space&&(t=this.out_space.map(function(e){return r.n2c(e).output()}).join(""));for(var s=0;s<this.operators.length;s++){var a=this.operators[s];e=a.apply(e,r)}for(var o="",i=0;i<e.length;i++){var n=e[i];switch(n){case"":break;case"*UNKNOWN":o+=Glaemscribe.UNKNOWN_CHAR_OUTPUT;break;case"*SPACE":o+=t;break;case"*LF":o+="\n";default:var l=r.n2c(n);o+=l?l.output():Glaemscribe.UNKNOWN_CHAR_OUTPUT}}return o},Glaemscribe.TranscriptionProcessor=function(e){return this.mode=e,this.rule_groups={},this},Glaemscribe.TranscriptionProcessor.prototype.finalize=function(e){var r=this,t=this.mode;r.transcription_tree=new Glaemscribe.TranscriptionTreeNode(null,null,""),r.transcription_tree.add_subpath(Glaemscribe.WORD_BOUNDARY,[""]),r.transcription_tree.add_subpath(Glaemscribe.WORD_BREAKER,[""]),this.rule_groups.glaem_each(function(r,t){t.finalize(e)}),r.in_charset={},this.rule_groups.glaem_each(function(e,s){s.in_charset.glaem_each(function(s,a){var o=r.in_charset[s];null!=o?t.errors.push(new Glaemscribe.Glaeml.Error(0,"Group "+e+" uses input character "+s+" which is also used by group "+o.name+". Input charsets should not intersect between groups.")):r.in_charset[s]=a})}),this.rule_groups.glaem_each(function(e,t){for(var s=0;s<t.rules.length;s++)for(var a=t.rules[s],o=0;o<a.sub_rules.length;o++){var i=a.sub_rules[o];r.add_subrule(i)}})},Glaemscribe.TranscriptionProcessor.prototype.add_subrule=function(e){var r=e.src_combination.join("");this.transcription_tree.add_subpath(r,e.dst_combination)},Glaemscribe.TranscriptionProcessor.prototype.apply=function(e,r){for(var t=[],s=null,a="",o=e.split(""),i=0;i<o.length;i++){var n=o[i];switch(n){case" ":case"	":t=t.concat(this.transcribe_word(a,r)),t=t.concat("*SPACE"),a="";break;case"\r":break;case"\n":t=t.concat(this.transcribe_word(a,r)),t=t.concat("*LF"),a="";break;default:var l=this.in_charset[n];l==s?a+=n:(t=t.concat(this.transcribe_word(a,r)),s=l,a=n)}}return t=t.concat(this.transcribe_word(a,r))},Glaemscribe.TranscriptionProcessor.prototype.transcribe_word=function(e,r){for(var t=[],e=Glaemscribe.WORD_BOUNDARY+e+Glaemscribe.WORD_BOUNDARY;0!=e.length;){var s=this.transcription_tree.transcribe(e),a=s[0],o=s[1],i=e.substring(0,o);e=e.substring(o),t=t.concat(a),r.processor_pathes.push([i,a,a])}return t},Glaemscribe.DowncasePreProcessorOperator=function(e){return Glaemscribe.PreProcessorOperator.call(this,e),this},Glaemscribe.DowncasePreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.DowncasePreProcessorOperator.prototype.apply=function(e){return e.toLowerCase()},Glaemscribe.resource_manager.register_pre_processor_class("downcase",Glaemscribe.DowncasePreProcessorOperator),Glaemscribe.RxSubstitutePreProcessorOperator=function(e){return Glaemscribe.PreProcessorOperator.call(this,e),this},Glaemscribe.RxSubstitutePreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.RxSubstitutePreProcessorOperator.prototype.finalize=function(e){Glaemscribe.PreProcessorOperator.prototype.finalize.call(this,e),this.finalized_glaeml_element.args[1]=this.finalized_glaeml_element.args[1].replace(/(\\\d)/g,function(e){return"$"+e.replace("\\","")})},Glaemscribe.RxSubstitutePreProcessorOperator.prototype.apply=function(e){var r=new RegExp(this.finalized_glaeml_element.args[0],"g"),t=this.finalized_glaeml_element.args[1];return e.replace(r,t)},Glaemscribe.resource_manager.register_pre_processor_class("rxsubstitute",Glaemscribe.RxSubstitutePreProcessorOperator),Glaemscribe.SubstitutePreProcessorOperator=function(e){return Glaemscribe.PreProcessorOperator.call(this,e),this},Glaemscribe.SubstitutePreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.SubstitutePreProcessorOperator.prototype.apply=function(e){var r=new RegExp(this.finalized_glaeml_element.args[0],"g"),t=this.finalized_glaeml_element.args[1];return e.replace(r,t)},Glaemscribe.resource_manager.register_pre_processor_class("substitute",Glaemscribe.SubstitutePreProcessorOperator),Glaemscribe.UpDownTehtaSplitPreProcessorOperator=function(e){return Glaemscribe.PreProcessorOperator.call(this,e),this},Glaemscribe.UpDownTehtaSplitPreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.UpDownTehtaSplitPreProcessorOperator.prototype.finalize=function(e){Glaemscribe.PreProcessorOperator.prototype.finalize.call(this,e);var r=this,t=r.finalized_glaeml_element.args,s=t[0],a=t[1];s=s.split(/,/).map(function(e){return e.trim()}),a=a.split(/,/).map(function(e){return e.trim()}),this.vowel_map={},this.consonant_map={},this.splitter_tree=new Glaemscribe.TranscriptionTreeNode(null,null,""),this.word_split_map={};for(var o=0;o<s.length;o++){var i=s[o];this.splitter_tree.add_subpath(i,i),this.vowel_map[i]=i}for(var n=0;n<a.length;n++){var l=a[n];this.splitter_tree.add_subpath(l,l),this.consonant_map[l]=l}for(var c=s.concat(a).join("").split("").sort().unique(),p=0;p<c.length;p++){var u=c[p];this.word_split_map[u]=u}},Glaemscribe.UpDownTehtaSplitPreProcessorOperator.prototype.type_of_token=function(e){return null!=this.vowel_map[e]?"V":null!=this.consonant_map[e]?"C":"X"},Glaemscribe.UpDownTehtaSplitPreProcessorOperator.prototype.apply_to_word=function(e){var r=[];if(""==e.trim())r.push(e);else for(;0!=e.length;){var t=this.splitter_tree.transcribe(e),s=t[0],a=t[1];s instanceof Array&&s.equals([Glaemscribe.UNKNOWN_CHAR_OUTPUT])?r.push(e[0]):r.push(s),e=e.substring(a)}for(var o=[],i=0;i<r.length-2;){var n=r[i],l=r[i+1],c=r[i+2],p=this.type_of_token(n),u=this.type_of_token(l),h=this.type_of_token(c);"C"==p&&"V"==u&&"C"==h?(o.push(r[i]),o.push("@"),o.push(r[i+1]),i+=2):(o.push(r[i]),i+=1)}for(;i<r.length;)o.push(r[i]),i+=1;return o.join("")},Glaemscribe.UpDownTehtaSplitPreProcessorOperator.prototype.apply=function(e){for(var r="",t="",s=e.split(""),a=0;a<s.length;a++){var o=s[a];null!=this.word_split_map[o]?r+=o:(t+=this.apply_to_word(r),t+=o,r="")}return t+=this.apply_to_word(r)},Glaemscribe.resource_manager.register_pre_processor_class("up_down_tehta_split",Glaemscribe.UpDownTehtaSplitPreProcessorOperator),Glaemscribe.ElvishNumbersPreProcessorOperator=function(e){return Glaemscribe.PreProcessorOperator.call(this,e),this},Glaemscribe.ElvishNumbersPreProcessorOperator.inheritsFrom(Glaemscribe.PreProcessorOperator),Glaemscribe.ElvishNumbersPreProcessorOperator.prototype.apply=function(e){var r=this,t=r.finalized_glaeml_element.args[0];t=null!=t?parseInt(t):12;var s=r.finalized_glaeml_element.args[1];return s=null!=s?1==s||"true"==s:!0,e.replace(/\d+/g,function(e){var r=parseInt(e).toString(t);r=r.toUpperCase();var a="";if(s)for(var o=r.length-1;o>=0;o--)a+=r[o];else a=r;return a})},Glaemscribe.resource_manager.register_pre_processor_class("elvish_numbers",Glaemscribe.ElvishNumbersPreProcessorOperator),Glaemscribe.ReversePostProcessorOperator=function(e){return Glaemscribe.PostProcessorOperator.call(this,e),this},Glaemscribe.ReversePostProcessorOperator.inheritsFrom(Glaemscribe.PostProcessorOperator),Glaemscribe.ReversePostProcessorOperator.prototype.apply=function(e){return e.reverse()},Glaemscribe.resource_manager.register_post_processor_class("reverse",Glaemscribe.ReversePostProcessorOperator),Glaemscribe.ResolveVirtualsPostProcessorOperator=function(e){return Glaemscribe.PostProcessorOperator.call(this,e),this},Glaemscribe.ResolveVirtualsPostProcessorOperator.inheritsFrom(Glaemscribe.PostProcessorOperator),Glaemscribe.ResolveVirtualsPostProcessorOperator.prototype.finalize=function(e){Glaemscribe.PostProcessorOperator.prototype.finalize.call(this,e),this.last_triggers={}},Glaemscribe.ResolveVirtualsPostProcessorOperator.prototype.reset_trigger_states=function(e){var r=this;e.virtual_chars.glaem_each(function(e,t){t.object_reference=e,r.last_triggers[t.object_reference]=null})},Glaemscribe.ResolveVirtualsPostProcessorOperator.prototype.apply_loop=function(e,r,t,s,a){var o=this;if("*SPACE"==s)return void o.reset_trigger_states(e);var i=e.n2c(s);if(null!=i)if(i.is_virtual()&&t==i.reversed){var n=o.last_triggers[i.object_reference];null!=n&&(r[a]=n.names[0])}else e.virtual_chars.glaem_each(function(e,r){var t=r.n2c(s);null!=t&&(o.last_triggers[r.object_reference]=t)})},Glaemscribe.ResolveVirtualsPostProcessorOperator.prototype.apply=function(e,r){var t=this;return t.reset_trigger_states(r),e.glaem_each(function(s,a){t.apply_loop(r,e,!1,a,s)}),t.reset_trigger_states(r),e.glaem_each_reversed(function(s,a){t.apply_loop(r,e,!0,a,s)}),e},Glaemscribe.resource_manager.register_post_processor_class("resolve_virtuals",Glaemscribe.ResolveVirtualsPostProcessorOperator),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var r;r="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,r.shellwords=e()}}(function(){return function e(r,t,s){function a(i,n){if(!t[i]){if(!r[i]){var l="function"==typeof require&&require;if(!n&&l)return l(i,!0);if(o)return o(i,!0);var c=new Error("Cannot find module '"+i+"'");throw c.code="MODULE_NOT_FOUND",c}var p=t[i]={exports:{}};r[i][0].call(p.exports,function(e){var t=r[i][1][e];return a(t?t:e)},p,p.exports,e,r,t,s)}return t[i].exports}for(var o="function"==typeof require&&require,i=0;i<s.length;i++)a(s[i]);return a}({1:[function(e,r,t){(function(){var e;e=function(e,r,t){var s,a;for(a="";e.length>0;)s=e.match(r),s?(a+=e.slice(0,s.index),a+=t(s),e=e.slice(s.index+s[0].length)):(a+=e,e="");return a},t.split=function(r){var t,s;return null==r&&(r=""),s=[],t="",e(r,/\s*(?:([^\s\\\'\"]+)|'((?:[^\'\\]|\\.)*)'|"((?:[^\"\\]|\\.)*)"|(\\.?)|(\S))(\s|$)?/,function(e){var r,a,o,i,n,l,c;if(i=e[0],c=e[1],l=e[2],r=e[3],a=e[4],o=e[5],n=e[6],null!=o)throw new Error("Unmatched quote");return t+=c||(l||r||a).replace(/\\(?=.)/,""),null!=n?(s.push(t),t=""):void 0}),t&&s.push(t),s},t.escape=function(e){return null==e&&(e=""),null==e?"''":e.replace(/([^A-Za-z0-9_\-.,:\/@\n])/g,"\\$1").replace(/\n/g,"'\n'")}}).call(this)},{}]},{},[1])(1)});